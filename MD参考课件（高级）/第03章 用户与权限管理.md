# 1. 用戶管理
## 1.1 登录MySQL服务器
### 🔐 一、什麼是「登錄 MySQL 伺服器」？

這個動作指的是：
> 使用帳號密碼，透過命令列工具 `mysql` 連接到正在運行的 MySQL 服務（通常在本機或遠端伺服器上）。

你可以透過「本機連線」或「遠端連線」兩種方式進行登錄。

---

### 📌 二、登錄指令語法說明

#### 基本語法：

```bash
mysql -h hostname -P port -u username -p DatabaseName -e "SQL語句"
```

| 參數 | 說明 |
|------|------|
| `-h hostname` | 指定伺服器主機名稱或 IP，預設是 `localhost` |
| `-P port` | 指定連接埠，預設是 `3306` |
| `-u username` | 指定用戶名稱，例如 `root` |
| `-p` | 要求輸入密碼（執行後會提示） |
| `DatabaseName` | 登錄後自動使用的資料庫名稱（可選） |
| `-e "SQL語句"` | 登錄後直接執行 SQL 指令並顯示結果 |

---

### 🧪 三、範例操作與解說

#### ✅ 範例 1：最簡單的登入（本機、預設資料庫）

```bash
mysql -u root -p
```

這會：
- 登錄本機 `localhost`
- 使用 `root` 帳號
- 提示輸入密碼
- 成功後會進入 MySQL 命令列互動模式（類似 REPL）

---

#### ✅ 範例 2：登入並使用 `mysql` 資料庫

```bash
mysql -u root -p mysql
```

這會：
- 登錄 MySQL 並自動選擇 `mysql` 資料庫

---

#### ✅ 範例 3：登入後直接查詢 `user` 表中的資料

```bash
mysql -u root -p -h localhost -P 3306 mysql -e "SELECT Host, User FROM user;"
```

這會：
- 使用 root 帳號、密碼
- 連接本機的 3306 埠
- 指定使用 `mysql` 資料庫
- 查詢該資料庫下的 `user` 表，並印出 `Host` 和 `User` 欄位的值
- 執行完後**不會進入互動模式**，而是直接退出

---

#### ✅ 範例 4：登入遠端 MySQL 伺服器

```bash
mysql -h 192.168.1.100 -u admin -p
```

這會：
- 登入位於 `192.168.1.100` 的 MySQL 伺服器
- 使用帳號 `admin`
- 提示輸入密碼

---

### 🔐 四、密碼的輸入方式（注意事項）

- `-p` 後面**不能直接加密碼**（不安全，也會報錯）
- 正確方式是執行後讓系統提示你輸入密碼

錯誤方式（不建議）：
```bash
mysql -u root -p123456  ❌
```

---

### 🛠️ 五、常見錯誤處理

| 錯誤訊息 | 可能原因 |
|----------|----------|
| `Access denied for user` | 密碼錯誤或用戶沒有權限 |
| `Can't connect to MySQL server` | IP、Port 或服務未啟動 |
| `Unknown database` | 指定的資料庫不存在 |

---

## 1.2 創建用戶
### ✅ 一、什麼是 `CREATE USER`

`CREATE USER` 是 MySQL 中用來**新增帳號（用戶）**的語句，讓指定的帳號可以從某個主機登入 MySQL。

用戶帳號的格式為：

```
'使用者名稱'@'主機位址'
```

- **使用者名稱（User）**：帳號的名稱
- **主機位址（Host）**：限制此帳號從哪裡可以連線，常見值：
  - `'localhost'`：只能從本機連線
  - `'%'`：允許從任何主機連線（較危險）
  - `'192.168.1.100'`：只能從指定 IP 連線

---

### 🧱 二、語法格式

```sql
CREATE USER '使用者名稱'@'主機位址' IDENTIFIED BY '密碼';
```

可一次建立多個使用者：

```sql
CREATE USER 
  'user1'@'localhost' IDENTIFIED BY 'pwd1',
  'user2'@'%' IDENTIFIED BY 'pwd2';
```

---

### 🧪 三、範例解說

#### ✅ 範例 1：建立一個本機使用者

```sql
CREATE USER 'alice'@'localhost' IDENTIFIED BY 'securePwd123';
```

📌 表示使用者 `alice` 只能從 **本機** 登入 MySQL，登入時需要輸入密碼 `securePwd123`。

---

#### ✅ 範例 2：建立一個遠端用戶

```sql
CREATE USER 'devuser'@'%' IDENTIFIED BY 'devpass';
```

📌 表示 `devuser` 可以從**任何主機**登入（前提是防火牆與權限允許），使用密碼 `devpass`。

---

#### ✅ 範例 3：一次建立多個使用者

```sql
CREATE USER 
  'admin1'@'localhost' IDENTIFIED BY 'adminpwd1',
  'admin2'@'192.168.0.100' IDENTIFIED BY 'adminpwd2';
```

📌 表示建立兩個帳號，且從不同主機登入 MySQL。

---

#### ✅ 範例 4：建立一個不設密碼的使用者（⚠️不建議）

```sql
CREATE USER 'nopwduser'@'localhost';
```

📌 此使用者登入時不需密碼，**安全性很差**，僅用於測試環境！

---

### 🔐 四、建立用戶 ≠ 立即有操作權限

建立完帳號後，該用戶**預設沒有任何權限**。你還需要配合 `GRANT` 給他權限，例如：

```sql
GRANT ALL PRIVILEGES ON mydb.* TO 'alice'@'localhost';
```

📌 這樣 alice 才能對 `mydb` 資料庫執行操作（查詢、插入、更新、刪除等）。

---

### 🧹 五、查看與刪除用戶

#### 查看所有用戶：

```sql
SELECT user, host FROM mysql.user;
```

#### 刪除用戶：

```sql
DROP USER 'alice'@'localhost';
```

---

## 1.3 修改用户
### ✅ 一、什麼是「MySQL 修改用戶」

修改用戶通常指：

1. **修改用戶名稱（RENAME）**
2. **修改登入主機（HOST）**
3. **修改密碼**
4. **修改用戶資訊（例如 plugin、authentication_string）**

---

### 🧠 二、不推薦的方式：直接操作 `mysql.user` 表

你提供的語法如下：

```sql
UPDATE mysql.user SET USER='li4' WHERE USER='wang5'; 
FLUSH PRIVILEGES;
```

這樣雖然能把 `wang5` 改成 `li4`，但：
- 這是直接操作 **系統資料表**
- 可能導致權限資訊混亂或無效
- **MySQL 8.0 起**，很多欄位已改變，不建議這樣做

> ✅ 建議使用官方提供的語法：`RENAME USER`、`ALTER USER`

---

### 🛠️ 三、正確做法：使用 RENAME USER 語句

#### ✅ 修改用戶名稱：

```sql
RENAME USER 'wang5'@'localhost' TO 'li4'@'localhost';
```

📌 表示將 `wang5@localhost` 改為 `li4@localhost`，權限會保留。

---

### 🔑 四、修改密碼的方式

#### ✅ MySQL 5.7 以前：

```sql
SET PASSWORD FOR 'li4'@'localhost' = PASSWORD('newpassword');
```

#### ✅ MySQL 5.7+ 或 8.0：

```sql
ALTER USER 'li4'@'localhost' IDENTIFIED BY 'newpassword';
```

---

### 🌐 五、修改 Host（登入來源）

MySQL **不支援直接修改用戶的 Host**，你需要刪除並重新建立：

```sql
-- 複製原帳號的權限給新帳號
CREATE USER 'li4'@'%' IDENTIFIED BY 'mypwd';
GRANT ALL PRIVILEGES ON *.* TO 'li4'@'%';

-- 刪除原帳號
DROP USER 'li4'@'localhost';
```

---

### 🧪 六、綜合範例：更名 + 修改密碼

```sql
RENAME USER 'olduser'@'localhost' TO 'newuser'@'localhost';
ALTER USER 'newuser'@'localhost' IDENTIFIED BY 'NewPass123';
```

---

### 🧹 七、補充說明：FLUSH PRIVILEGES 是什麼？

當你 **直接更新 mysql.user 表** 時，需要：

```sql
FLUSH PRIVILEGES;
```

👉 它的意思是「**讓 MySQL 重新讀取用戶權限表**」，否則你修改的內容不會立即生效。

> 但如果你使用的是 `ALTER USER` 或 `RENAME USER` 等語句，就不需要這行，因為它們會自動刷新權限。

---

## 1.4 刪除用戶
### ✅ 一、MySQL 刪除用戶的目的

刪除用戶的主要目的是：

- 移除不再需要的帳號
- 防止未授權使用者存取資料庫
- 清理系統中的無效帳號

---

### 🔐 二、方式一：使用 `DROP USER`（✅推薦方式）

#### ⭐ 語法：

```sql
DROP USER '用戶名'@'主機';
```

- 可以同時刪多個帳號，用逗號分隔
- 會一併刪除該用戶在 `mysql.user`、`mysql.db` 等權限表中的紀錄
- 不需手動 `FLUSH PRIVILEGES`，會自動刷新

#### ✅ 範例 1：刪除本機帳號

```sql
DROP USER 'li4'@'localhost';
```

#### ✅ 範例 2：刪除預設 `%` 主機（任何位置登入）

```sql
DROP USER 'li4';
-- 等同於 'li4'@'%'
```

#### ✅ 範例 3：一次刪除多個使用者

```sql
DROP USER 'li4'@'localhost', 'emily'@'192.168.1.5';
```

---

### 🚫 三、方式二：使用 `DELETE FROM mysql.user`（❌不建議）

#### ⚠️ 不推薦的原因：

- 這只是從 `mysql.user` 表刪除資料
- **不會自動清除其它權限表（如 mysql.db、mysql.tables_priv）**
- 容易導致資料庫內仍殘留該用戶的權限記錄，造成系統異常或資安風險
- **必須手動 `FLUSH PRIVILEGES`** 使更動生效

#### 🧨 語法：

```sql
DELETE FROM mysql.user WHERE User='Emily' AND Host='localhost';
FLUSH PRIVILEGES;
```

---

### 👀 四、查詢目前有哪些使用者

在刪除之前，你可以先列出有哪些帳號：

```sql
SELECT User, Host FROM mysql.user;
```

這樣可以確保你刪除的是正確帳號（尤其是當同一個使用者名稱有不同 Host 時）

---

### 🧹 五、如果你忘記 Host 是什麼？

查詢 user 表時，觀察該用戶對應的 Host：

```sql
SELECT Host, User FROM mysql.user WHERE User = 'li4';
```

---

### 🔄 六、常見補充：忘記 DROP USER 怎麼辦？

如果你用 DELETE 誤刪某個帳號導致權限錯亂，可採用以下修復方式：

```sql
-- 重建帳號
CREATE USER 'li4'@'localhost' IDENTIFIED BY 'mypassword';

-- 重新授權
GRANT ALL PRIVILEGES ON *.* TO 'li4'@'localhost';

-- 最後如果需要刪除，使用正確方式刪除
DROP USER 'li4'@'localhost';
```

---

### ✅ 總結建議

| 操作方式 | 安全性 | 是否自動清除權限 | 需手動刷新 | 建議用途 |
|----------|--------|------------------|-------------|-----------|
| `DROP USER` | ✅ 安全 | ✅ 是 | ❌ 否 | 日常操作 |
| `DELETE FROM mysql.user` | ❌ 不安全 | ❌ 否 | ✅ 是 | 除錯或緊急用，**需小心** |

---

## 1.5 設置當前用戶密碼
### ✅ 一、為什麼要設定目前用戶的密碼？

MySQL 中密碼是用來保護資料庫安全的第一道防線，尤其是像 `root` 這樣的超級帳號，若沒有妥善設置密碼，很容易造成重大資安風險。

常見的修改情境：
- 初次安裝 MySQL，root 沒有密碼
- 忘記密碼後重設
- 定期變更密碼（安全政策）

---

### 📌 二、版本差異說明（重要）

| MySQL 版本 | 是否支援 PASSWORD() | 推薦語法                |
|-------------|---------------------|--------------------------|
| < 5.7        | ✅ 使用 PASSWORD() | `SET PASSWORD = PASSWORD('...')` |
| ≥ 5.7        | ⚠️ 慢慢棄用         | `ALTER USER` or `SET PASSWORD` |
| ≥ 8.0        | ❌ 移除 PASSWORD() | ✅ `ALTER USER` 是官方推薦 |

---

### 🛠️ 三、推薦方式：修改「當前使用者」密碼

#### ✅ 方法 1：使用 `ALTER USER`（官方推薦）

```sql
ALTER USER USER() IDENTIFIED BY 'NewSecurePassword!';
```

🔎 解說：
- `USER()` 是一個內建函數，會自動回傳目前登入帳號（例如 `'root'@'localhost'`）
- 此語句會修改「目前登入帳號」的密碼

📌 **MySQL 5.7+ 推薦使用，MySQL 8.0 更是唯一推薦方式**

---

#### ✅ 方法 2：使用 `SET PASSWORD`（次推薦）

```sql
SET PASSWORD = 'NewSecurePassword!';
```

🔎 解說：
- 會自動加密密碼
- 不需要指定帳號，修改目前使用者密碼

📌 **MySQL 5.7+ 可用，8.0 中仍可用，但不如 `ALTER USER` 明確**

---

### ❌ 四、不再推薦的舊方法（MySQL 5.7 以前用）

```sql
SET PASSWORD = PASSWORD('NewSecurePassword!');
```

或

```sql
UPDATE mysql.user SET authentication_string = PASSWORD('NewSecurePassword!') WHERE User = 'xxx';
FLUSH PRIVILEGES;
```

📌 缺點：
- 需要直接操作系統資料表 `mysql.user`
- 容易造成殘留問題或版本相容性錯誤
- **MySQL 8.0 已移除 `PASSWORD()` 函數**

---

### 🧪 五、完整範例

#### 💻 登入 MySQL

```bash
mysql -u root -p
```

#### ✅ 修改當前用戶密碼（強烈推薦）

```sql
ALTER USER USER() IDENTIFIED BY 'MyNewP@ssw0rd!';
```

或者：

```sql
SET PASSWORD = 'MyNewP@ssw0rd!';
```

#### 🔐 修改成功後可重新登入驗證：

```bash
mysql -u root -p
# 輸入剛剛新設的密碼登入
```

---

### 🧠 六、補充：如果你是 root，要幫其他人改密碼

你也可以這樣指定帳號來修改：

```sql
ALTER USER 'alice'@'localhost' IDENTIFIED BY 'AliceSecure123';
```

---

### ✅ 總結比較

| 方法 | 是否支援 MySQL 8.0 | 是否推薦 | 是否需指定用戶 | 是否自動加密 |
|------|----------------------|-----------|------------------|----------------|
| `ALTER USER USER()` | ✅ 是 | ✅ 非常推薦 | ❌ 不需指定 | ✅ |
| `SET PASSWORD = ...` | ✅ 是 | ✅ 可接受 | ❌ 不需指定 | ✅ |
| `SET PASSWORD = PASSWORD(...)` | ❌ 不支援 | ❌ 不推薦 | ❌ | ✅ |
| `UPDATE mysql.user` | ❌ 不支援 | ❌ 強烈不建議 | ✅ 要指定 | ⚠️ 不保證 |

---

## 1.6 修改其他用戶密碼
### ✅ 一、誰可以修改其他用戶的密碼？

- ✅ **`root`**（或擁有 `ALTER USER`、`UPDATE` 權限的管理員）才可以修改其他帳號的密碼。
- 普通用戶**只能改自己的密碼**，不能改別人的。

---

### 📌 二、推薦的方式一：使用 `ALTER USER`（✅MySQL 官方建議）

#### 🔧 語法格式：
```sql
ALTER USER 'username'@'host' IDENTIFIED BY 'new_password';
```

- `username`：使用者帳號
- `host`：該帳號可連線的主機（如 `localhost`, `%`）
- `new_password`：新密碼（會自動加密）

---

#### ✅ 範例：修改 `kangshifu@localhost` 的密碼為 `HelloWorld_123`

```sql
ALTER USER 'kangshifu'@'localhost' IDENTIFIED BY 'HelloWorld_123';
```

也可以一次改多個帳號：

```sql
ALTER USER 
  'alice'@'localhost' IDENTIFIED BY 'Alice123!',
  'bob'@'%' IDENTIFIED BY 'Bob456!';
```

📌 **適用於 MySQL 5.7+ 與 8.0，安全、標準、會自動刷新權限**

---

### 📌 三、推薦的方式二：使用 `SET PASSWORD FOR`（也可行）

#### 🔧 語法格式：

```sql
SET PASSWORD FOR 'username'@'host' = 'new_password';
```

#### ✅ 範例：

```sql
SET PASSWORD FOR 'kangshifu'@'localhost' = 'HelloWorld_123';
```

📌 同樣會自動加密密碼，但部分版本不支援一次設定多個帳號

---

### ⚠️ 四、不推薦的方式三：直接 UPDATE `mysql.user`（舊版使用）

#### ❌ 為什麼不推薦？

- MySQL 8.0 **已移除** `PASSWORD()` 函數
- 直接操作系統表可能導致權限異常或遺留資料
- 需要 `FLUSH PRIVILEGES` 手動刷新
- 不會更新與帳號相關的其他資訊（plugin、expiry 等）

---

#### ⚠️ 舊範例（5.5 ~ 5.7 可用，不支援 8.0）：

```sql
UPDATE mysql.user 
SET authentication_string = PASSWORD('123456') 
WHERE User = 'li4' AND Host = 'localhost';

FLUSH PRIVILEGES;
```

MySQL 5.5 以前可能還使用：

```sql
UPDATE mysql.user 
SET Password = PASSWORD('123456') 
WHERE User = 'li4';
```

---

### 🧠 五、如何確認修改成功？

你可以用以下語法查詢該帳號是否存在：

```sql
SELECT User, Host FROM mysql.user WHERE User = 'kangshifu';
```

若要確認是否有登入成功，可以嘗試使用該新密碼登入：

```bash
mysql -u kangshifu -p
# 然後輸入新密碼 HelloWorld_123
```

---

### ✅ 六、總結：三種方式比較

| 方法                     | 是否推薦 | 是否支援 MySQL 8 | 是否需刷新 | 說明 |
|--------------------------|-----------|-------------------|--------------|------|
| `ALTER USER`             | ✅ 強烈推薦 | ✅ 是            | ❌ 否         | 最安全、標準，支援多用戶 |
| `SET PASSWORD FOR`       | ✅ 可接受   | ✅ 是            | ❌ 否         | 次佳選擇，簡潔明確 |
| `UPDATE mysql.user`      | ❌ 不建議   | ❌ 不支援       | ✅ 需要        | 舊式操作，容易殘留問題 |

---

## 1.7 MySQL8密码管理
### 1.7.1 密码过期策略
### 🧠 一、什麼是 MySQL 密碼過期策略？

MySQL 提供了密碼過期機制，以提升安全性。透過這個策略，系統可要求使用者定期更換密碼，避免因長期未變更密碼導致帳號遭駭的風險。

密碼過期策略可分為兩種：

| 類型 | 應用範圍 | 舉例說明 |
|------|------------|----------|
| **全局策略** | 套用到所有使用者（除非另行指定） | 密碼每 180 天過期 |
| **個別策略** | 針對特定使用者設置不同的過期條件 | 指定 `kangshifu` 每 90 天過期 |

---

### 🛠 二、實作方式說明與範例

#### 1️⃣ 手動立即讓密碼過期

讓某個帳號的密碼「馬上」過期，用於強制要求使用者下次登入時重設密碼。

```sql
ALTER USER 'kangshifu'@'localhost' PASSWORD EXPIRE;
```

💡 **效果**：
- 使用者可以登入，但不能執行查詢等操作，必須先更新密碼。

---

#### 2️⃣ 設定全局密碼過期策略（適用所有用戶）

MySQL 的變數 `default_password_lifetime` 控制密碼多久會自動過期。

##### 方式 1：使用 SQL 動態設置並持久化
```sql
SET PERSIST default_password_lifetime = 180;
```

##### 方式 2：直接編輯設定檔 `my.cnf`
```ini
[mysqld]
default_password_lifetime = 180
```

📌 **補充說明**：
- 預設值為 `0`，表示密碼永不過期。
- 一旦啟用，未指定特殊規則的帳戶都會受到影響。

---

#### 3️⃣ 為個別帳戶設定密碼過期時間

##### ✅ 設定某帳號每 90 天過期
```sql
ALTER USER 'kangshifu'@'localhost' PASSWORD EXPIRE INTERVAL 90 DAY;
```

##### ✅ 永不過期
```sql
ALTER USER 'kangshifu'@'localhost' PASSWORD EXPIRE NEVER;
```

##### ✅ 套用全局策略（預設）
```sql
ALTER USER 'kangshifu'@'localhost' PASSWORD EXPIRE DEFAULT;
```

💡 注意：你也可以在 `CREATE USER` 時直接加上這些設定。

---

### ✅ 三、練習範例（模擬場景）

#### 🎯 目標：強制 kangshifu 在 90 天內需改密碼一次，但目前先讓他馬上更新密碼

```sql
-- 1. 設定 kangshifu 每 90 天需改密碼
ALTER USER 'kangshifu'@'localhost' PASSWORD EXPIRE INTERVAL 90 DAY;

-- 2. 強制 kangshifu 立刻重新設定密碼
ALTER USER 'kangshifu'@'localhost' PASSWORD EXPIRE;
```

#### 🔐 使用者登入後須執行：
```sql
SET PASSWORD = 'NewSecurePass@2024';
```

---

### 🧩 四、其他補充知識

| 名稱 | 說明 |
|------|------|
| `PASSWORD EXPIRE` | 密碼立即過期 |
| `PASSWORD EXPIRE INTERVAL N DAY` | N 天後過期 |
| `PASSWORD EXPIRE NEVER` | 永不過期（不推薦） |
| `default_password_lifetime` | 控制全局過期天數（需 MySQL 5.7+） |
| `SET PASSWORD FOR` | 用於手動變更密碼 |

---

### 1.7.2密码重用策略
### 🔐 一、什麼是密碼重用策略？

密碼重用策略是 **防止使用者重複使用舊密碼** 的一種安全機制。此策略能有效防止用戶將密碼改來改去卻都差不多，進而減少被暴力破解或社交工程攻擊的風險。

MySQL 從 8.0 開始支持兩種密碼重用控制方式：

| 策略類型 | 說明 |
|----------|------|
| **依照次數限制（password_history）** | 限制新密碼不能與最近 N 次使用過的密碼相同 |
| **依照時間限制（password_reuse_interval）** | 限制新密碼不能與「最近 N 天內」使用過的密碼相同 |

> 兩種可以單獨使用，也可以同時設定。

---

### 🛠️ 二、設定方式與範例

#### ✅ 方式一：設定 **全局密碼重用限制**

##### 🧩 方法 1：SQL 方式設定（並永久生效）
```sql
SET PERSIST password_history = 6;               -- 限制不可與最近 6 次使用的密碼相同
SET PERSIST password_reuse_interval = 365;      -- 限制不可重複使用一年內曾用過的密碼
```

##### 🧩 方法 2：my.cnf 中設定（伺服器啟動時套用）
```ini
[mysqld]
password_history = 6
password_reuse_interval = 365
```

> 若兩者皆設，則必須同時滿足兩者條件才能變更密碼。

---

#### ✅ 方式二：針對「單一使用者」設定密碼重用策略

##### 🚫 禁止使用最近 5 次使用過的密碼
```sql
ALTER USER 'kangshifu'@'localhost' PASSWORD HISTORY 5;
```

##### 🕒 禁止重複使用 365 天內的密碼
```sql
ALTER USER 'kangshifu'@'localhost' PASSWORD REUSE INTERVAL 365 DAY;
```

##### 🔒 結合兩者：5 次 + 365 天內均不可重複
```sql
ALTER USER 'kangshifu'@'localhost' 
  PASSWORD HISTORY 5 
  PASSWORD REUSE INTERVAL 365 DAY;
```

---

### 💡 三、實務場景理解（模擬）

#### 🧪 模擬操作

```sql
-- 建立帳號 kangshifu 並設定密碼重用限制
CREATE USER 'kangshifu'@'localhost'
  IDENTIFIED BY 'Password@2023'
  PASSWORD HISTORY 3
  PASSWORD REUSE INTERVAL 180 DAY;

-- 使用者第一次變更密碼
SET PASSWORD FOR 'kangshifu'@'localhost' = 'Password@2024';

-- 第二次變更
SET PASSWORD FOR 'kangshifu'@'localhost' = 'Password@2025';

-- 第三次變更（想用 Password@2023）
SET PASSWORD FOR 'kangshifu'@'localhost' = 'Password@2023'; 
-- ❌ 錯誤！此密碼在最近三次中出現過，且 180 天內也曾用過，不能重複使用
```

---

### 📌 四、其他補充資訊

| 系統變數 | 功能 | 預設值 |
|-----------|------|--------|
| `password_history` | 密碼歷史記錄次數 | 0（不限制） |
| `password_reuse_interval` | 密碼可重用的最小時間 | 0（不限制） |

---

### ✅ 五、實務建議

- 🧱 建議在 **企業環境** 中設為全局預設策略，統一控管密碼使用行為。
- 🧑‍💼 對於重要帳號（如 `root` 或 DBA）可以設定更嚴格的個別策略。
- 🛡️ 配合「密碼複雜度規則」與「過期策略」能形成一套完整密碼政策。

---

# 2. 權限管理
> 关于 MySQL 的权限简单的理解就是 MySQL 允许你做你权力以内的事情，不可以越界。比如只允许你执行SELECT操作，那么你就不能执行UPDATE操作。只允许你从某台机器上连接MySQL，那么你就不能从除那台机器以外的其他机器连接 MySQL。

## 2.1 權限列表
### 🔐 一、MySQL 常見權限一覽（補充完整）

你可以使用以下語法查看目前系統支援的權限：

```sql
SHOW PRIVILEGES;
```

這個指令會列出所有 GRANT/REVOKE 中可用的權限類型。以下是依功能分類後的詳細說明：

| 權限名稱 | 說明 |
|----------|------|
| **ALL [PRIVILEGES]** | 授與所有可用的權限（不包含 GRANT OPTION） |
| **SELECT** | 查詢表中資料 |
| **INSERT** | 插入新資料 |
| **UPDATE** | 修改已有資料 |
| **DELETE** | 刪除資料 |
| **CREATE** | 建立新資料庫、表、索引、儲存程序等 |
| **DROP** | 刪除資料庫、表、索引、儲存程序等 |
| **RELOAD** | 使伺服器重新載入快取、權限表等（用於 `FLUSH`） |
| **SHUTDOWN** | 關閉 MySQL 伺服器 |
| **PROCESS** | 查看執行中的查詢（用於 `SHOW PROCESSLIST`） |
| **FILE** | 允許從伺服器本地檔案系統讀寫（如 `LOAD DATA`） |
| **GRANT OPTION** | 允許將本身具有的權限授予其他使用者 |
| **REFERENCES** | 創建外鍵時使用 |
| **INDEX** | 創建或刪除索引 |
| **ALTER** | 修改表的結構 |
| **CREATE TEMPORARY TABLES** | 建立臨時表 |
| **LOCK TABLES** | 鎖定表以進行控制（如只讀） |
| **EXECUTE** | 執行儲存程序或函式 |
| **CREATE VIEW** | 建立視圖 |
| **SHOW VIEW** | 查詢視圖定義 |
| **CREATE ROUTINE** | 建立儲存程序或函式 |
| **ALTER ROUTINE** | 更改或刪除儲存程序或函式 |
| **EVENT** | 建立、刪除或執行事件 |
| **TRIGGER** | 建立或移除觸發器 |
| **CREATE USER** | 建立新使用者 |
| **SUPER** | 執行某些管理指令（如 `SET GLOBAL`） |
| **REPLICATION SLAVE** | 用於主從複製（讀取 binlog） |
| **REPLICATION CLIENT** | 查詢複製狀態 |
| **USAGE** | 代表沒有特別權限，可登入使用者 |

---

### 📂 二、MySQL 權限的作用範圍（分層）

| 層級 | 權限適用範圍 | 例子 |
|------|--------------|------|
| **全域** | 整個 MySQL Server | `GRANT ALL ON *.* TO 'user'@'host';` |
| **資料庫** | 指定資料庫 | `GRANT SELECT ON mydb.* TO 'user'@'host';` |
| **資料表** | 資料庫中的某張表 | `GRANT INSERT ON mydb.users TO 'user'@'host';` |
| **欄位** | 某資料表的欄位 | `GRANT SELECT(name) ON mydb.users TO 'user'@'host';` |
| **儲存程序 / 函式** | 指定儲存程序、觸發器、事件等 | `GRANT EXECUTE ON PROCEDURE mydb.myproc TO 'user'@'host';` |

---

### 💡 三、GRANT 和 REVOKE 語法範例

#### 🔹 1. 建立使用者
```sql
CREATE USER 'app_user'@'localhost' IDENTIFIED BY 'password123';
```

#### 🔹 2. 賦予權限
```sql
-- 賦予 SELECT、INSERT 權限給 app_user 對某資料庫
GRANT SELECT, INSERT ON shop_db.* TO 'app_user'@'localhost';

-- 賦予執行儲存程序的權限
GRANT EXECUTE ON PROCEDURE shop_db.recalculate_totals TO 'app_user'@'localhost';

-- 賦予 GRANT 權限給某人（允許再授權）
GRANT SELECT ON shop_db.* TO 'manager'@'localhost' WITH GRANT OPTION;
```

#### 🔹 3. 收回權限
```sql
REVOKE INSERT ON shop_db.* FROM 'app_user'@'localhost';
```

#### 🔹 4. 刪除使用者
```sql
DROP USER 'app_user'@'localhost';
```

---

### 🧪 四、練習題範例

1. **給某個使用者僅能查詢 `employees` 表：**
```sql
GRANT SELECT ON company.employees TO 'report_user'@'localhost';
```

2. **給某個使用者能建立資料表但不能刪除：**
```sql
GRANT CREATE ON accounting_db.* TO 'dev_user'@'localhost';
```

3. **授予某人可執行函式與修改資料：**
```sql
GRANT EXECUTE, UPDATE ON *.* TO 'ops_user'@'localhost';
```

---

### 🧭 小提醒：檢查權限

使用以下指令可檢查使用者權限：
```sql
SHOW GRANTS FOR 'user'@'host';
```

---

## 2.2 授予权限的原则
> 权限控制主要是出于安全因素，因此需要遵循以下几个经验原则：

- 只授予能满足需要的最小权限，防止用户干坏事。比如用户只是需要查询，那就只给select权限就可以了，不要给用户赋予update、insert或者delete权限。

- 创建用户的时候限制用户的登录主机，一般是限制成指定IP或者内网IP段。

- 为每个用户设置满足密码复杂度的密码。

- 定期清理不需要的用户，回收权限或者删除用户。

## 2.3 授予权限
### 🔐 一、MySQL 授權方式的兩大類型
> 给用户授权的方式有 2 种，分别是通过把 **角色赋予** 和 **直接给用户授权** 。用户是数据库的使用者，我们可以通过给用户授予访问数据库中资源的权限，来控制使用者对数据库的访问，消除安全隐患。

#### ✅ 1. **直接授權給使用者（常見方式）**
最常見的授權方式，直接對使用者賦予權限。

```sql
GRANT SELECT, INSERT ON database.table TO 'user'@'host';
```

#### ✅ 2. **使用角色授權（MySQL 8.0+）**
先建立角色，再把角色授予使用者，達成權限統一管理。

```sql
-- 建立角色
CREATE ROLE 'readonly';

-- 給角色授權
GRANT SELECT ON mydb.* TO 'readonly';

-- 將角色賦予使用者
GRANT 'readonly' TO 'bob'@'%';

-- 啟用角色（登入後）
SET ROLE 'readonly';
```

---

### 📚 二、`GRANT` 語法結構補充解釋

```sql
GRANT 權限1, 權限2, ... ON 資料庫.資料表 TO '使用者'@'主機'
[IDENTIFIED BY '密碼']
[WITH GRANT OPTION];
```

| 語法項目             | 說明 |
|----------------------|------|
| `權限1, 權限2...`     | 指定要授予的權限，例如 SELECT、INSERT 等 |
| `資料庫.資料表`      | 指定授權對象，可使用 `*.*` 表示所有庫所有表 |
| `'使用者'@'主機'`    | 指定帳號與可登入來源，例如 `'joe'@'%'` |
| `IDENTIFIED BY`     | 如未存在此使用者則會自動建立並設定密碼 |
| `WITH GRANT OPTION` | 允許該使用者將自己擁有的權限再授予他人 |

---

### 🧪 三、實務授權範例

#### 🌟 1. 指定資料庫的讀寫權限

```sql
-- 給 'dev_user' 從本機登入者，在 atguigudb 資料庫中 SELECT、INSERT、UPDATE、DELETE 權限
GRANT SELECT, INSERT, UPDATE, DELETE ON atguigudb.* TO 'dev_user'@'localhost' IDENTIFIED BY 'devpass';
```

#### 🌍 2. 允許任何來源登入並擁有所有權限（不含GRANT）

```sql
GRANT ALL PRIVILEGES ON *.* TO 'admin'@'%' IDENTIFIED BY 'admin123';
```

#### 🛠 3. 授權後再補加其他權限（會疊加）

```sql
-- 初始授權 SELECT 權限
GRANT SELECT ON salesdb.* TO 'analyst'@'192.168.1.%';

-- 後續補加 INSERT 權限
GRANT INSERT ON salesdb.* TO 'analyst'@'192.168.1.%';
```

#### 🔑 4. 使用 WITH GRANT OPTION 授權再授權

```sql
-- 'manager' 擁有完整權限，並可將其權限再授予他人
GRANT ALL PRIVILEGES ON projectdb.* TO 'manager'@'%' IDENTIFIED BY 'm456' WITH GRANT OPTION;
```

---

### 📊 四、橫向 vs 縱向授權解釋

| 類型 | 說明 | 舉例 |
|------|------|------|
| **橫向分組** | 決定使用者可接觸的資料範圍 | A只能看`salesdb.*`，B只能看`marketingdb.*` |
| **縱向分組** | 決定使用者可對資料做什麼動作 | C可看、改資料（SELECT/UPDATE），D只能看（SELECT） |

**範例：**

```sql
-- 橫向控制: user_a 只能查詢 salesdb
GRANT SELECT ON salesdb.* TO 'user_a'@'localhost';

-- 縱向控制: user_b 對 marketingdb.users 具有增刪查權限
GRANT SELECT, INSERT, DELETE ON marketingdb.users TO 'user_b'@'localhost';
```

---

### 🧹 五、安全與管理建議

1. **最小權限原則**：只授予業務需要的最小權限。
2. **分主機授權**：根據 IP 來源授權，避免濫用。
3. **避免濫用 `WITH GRANT OPTION`**：僅授予受信任的管理帳號。
4. **定期檢查與回收權限**：
   ```sql
   SHOW GRANTS FOR 'user'@'host';
   REVOKE ALL PRIVILEGES, GRANT OPTION FROM 'user'@'host';
   ```

---

## 2.4 查看权限
### 查看当前用户权限
```sql
SHOW GRANTS; 
# 或 
SHOW GRANTS FOR CURRENT_USER; 
# 或 
SHOW GRANTS FOR CURRENT_USER();
```

### 查看某用户的全局权限
```sql
SHOW GRANTS FOR 'user'@'主机地址';
```

## 2.5 收回權限
### 🔐 一、REVOKE 是什麼？

`REVOKE` 用於 **撤銷使用者的權限**。常見用途包括：
- 移除不再需要的操作權限（如 INSERT、DELETE）
- 在帳號保留但限制操作範圍的情況下
- 降低使用者帳號造成破壞的風險

---

### 📚 二、REVOKE 語法

```sql
REVOKE 權限1, 權限2, ... ON 資料庫.資料表 FROM '使用者'@'主機';
```

| 語法項目 | 說明 |
|----------|------|
| `權限1, 權限2...` | 欲撤銷的權限，可為 `SELECT`、`ALL PRIVILEGES` 等 |
| `資料庫.資料表` | 欲撤銷的範圍，例如 `mydb.users` 或 `*.*` |
| `'使用者'@'主機'` | 目標帳號與來源，例如 `'joe'@'%'` |

---

### 🧪 三、實務範例

#### ✅ 1. 撤銷對某個資料庫的基本操作權限
```sql
REVOKE SELECT, INSERT, UPDATE, DELETE ON salesdb.* FROM 'sales_user'@'localhost';
```

#### ✅ 2. 撤銷所有庫、所有表的所有權限（但不刪帳號）
```sql
REVOKE ALL PRIVILEGES ON *.* FROM 'admin'@'%';
```

#### ✅ 3. 收回儲存程序的執行權限
```sql
REVOKE EXECUTE ON PROCEDURE report_db.generate_monthly_report FROM 'report_user'@'192.168.1.%';
```

#### ✅ 4. 收回 WITH GRANT OPTION 權限（單獨移除再授權能力）
```sql
REVOKE GRANT OPTION ON hrdb.* FROM 'hr_mgr'@'localhost';
```

---

### 🔍 四、REVOKE 生效機制與注意事項

| 項目 | 說明 |
|------|------|
| 生效時機 | 須「重新登入」帳號後生效（MySQL 缓存權限） |
| 不會刪帳號 | `REVOKE` 不會刪除使用者，只是移除其操作權限 |
| 刪除帳號 | 若要徹底移除帳號，請使用 `DROP USER` |
| 權限分散 | 權限可來自多個 `GRANT`，撤銷時需指定完整範圍與來源 |

#### 🔥 補充錯誤處理
有時會出現錯誤：
```sql
ERROR 1227 (42000): Access denied; you need (at least one of) the SYSTEM_USER privilege(s) for this operation
```
解決方式：
```sql
GRANT SYSTEM_USER ON *.* TO 'root'@'localhost';
```
（或使用擁有該權限的帳號操作）

---

### 🛠 五、移除帳號的完整流程（建議做法）

1. **先查出其所有授權內容**
```sql
SHOW GRANTS FOR 'user'@'host';
```

2. **逐項使用 `REVOKE` 收回權限**
```sql
REVOKE ALL PRIVILEGES, GRANT OPTION ON *.* FROM 'user'@'host';
```

3. **最後刪除帳號**
```sql
DROP USER 'user'@'host';
```

---

### 🧠 六、最佳實務建議

| 建議 | 說明 |
|------|------|
| ✅ 使用最小權限原則 | 僅授與業務所需權限，避免 `ALL PRIVILEGES` |
| ✅ 避免硬編碼 root 密碼 | 不建議將 root 密碼寫死在程式中，應使用專用帳號 |
| ✅ 定期審查與回收權限 | 例如員工離職、職務異動時撤權限 |
| ✅ 用角色統一管理（MySQL 8.0+） | 利於權限批量分配與回收 |

---

# 3. 權限表
## 3.1 概述
> 當我們談到 **MySQL 權限管理系統** 時，「**權限表（Privilege Tables）**」是核心機制之一。它決定了哪些使用者能做什麼事、在哪個資料庫、哪張資料表，甚至是哪一個欄位或儲存程序上進行操作。

---

### 🔐 一、MySQL 權限表總覽

MySQL 的權限表儲存在 `mysql` 系統資料庫中，以下是幾個重要的權限表：

| 權限表名稱       | 管理範圍                       | 範例說明                           |
|------------------|--------------------------------|------------------------------------|
| `user`           | 全局（GLOBAL）層級            | 控制所有資料庫的權限，如 `SELECT`、`CREATE USER` |
| `db`             | 資料庫（DATABASE）層級        | 控制特定資料庫的權限               |
| `tables_priv`    | 資料表（TABLE）層級           | 控制某一張表的操作權限             |
| `columns_priv`   | 欄位（COLUMN）層級            | 控制資料表中個別欄位的權限         |
| `procs_priv`     | 儲存程序與函數（STORED ROUTINE） | 控制 `PROCEDURE` 或 `FUNCTION` 執行權限 |
| `proxies_priv`   | 使用者代理權限                 | 控制誰可以代理誰執行操作           |

---

### 🧠 二、啟動過程與記憶體

當 MySQL 啟動時：

1. 會從 `mysql` 資料庫載入所有權限表。
2. 權限資訊會被載入到記憶體中供快速查詢。
3. 當你新增或變更權限（例如用 `GRANT` / `REVOKE`），可使用：
   ```sql
   FLUSH PRIVILEGES;
   ```
   來強制重新載入權限表。

---

### 🧪 三、範例說明（逐層範圍）

#### 1. `user` 表（全局權限）
```sql
GRANT ALL PRIVILEGES ON *.* TO 'alice'@'localhost';
```
代表 `alice` 使用者在所有資料庫和表上都有所有權限（包含 SELECT、UPDATE、DELETE 等）。

#### 2. `db` 表（指定資料庫）
```sql
GRANT SELECT, INSERT ON mydb.* TO 'bob'@'%';
```
代表 `bob` 使用者可以在 `mydb` 資料庫的所有表中執行查詢與新增。

#### 3. `tables_priv` 表（指定資料表）
```sql
GRANT UPDATE ON mydb.customers TO 'carol'@'localhost';
```
代表 `carol` 使用者只能對 `mydb` 裡的 `customers` 表進行 UPDATE。

#### 4. `columns_priv` 表（指定欄位）
```sql
GRANT SELECT (name, email) ON mydb.customers TO 'dave'@'%';
```
代表 `dave` 使用者只能查詢 `customers` 表中的 `name` 和 `email` 欄位。

#### 5. `procs_priv` 表（儲存程序/函數）
```sql
GRANT EXECUTE ON PROCEDURE mydb.calculate_salary TO 'emma'@'localhost';
```
代表 `emma` 使用者可以執行儲存在 `mydb` 中的 `calculate_salary` 程序。

---

### 🛠 四、如何查看權限表內容？

可以使用以下查詢查看權限表：

```sql
SELECT * FROM mysql.user WHERE User = 'alice';
SELECT * FROM mysql.db WHERE User = 'bob';
SELECT * FROM mysql.tables_priv;
SELECT * FROM mysql.columns_priv;
SELECT * FROM mysql.procs_priv;
```

---

### 📌 五、注意事項

- 權限設置時，不會自動生效，除非使用 `FLUSH PRIVILEGES` 或透過 `GRANT` 指令直接修改。
- 權限設置的範圍應從大到小（Global → DB → Table → Column）依需求調整。
- 權限控制精細但複雜，需依據實際業務安全性需求做妥善配置。

---

## 3.2 user表
> user 表是 MySQL 中最重要的一个权限表， 记录用户账号和权限信息 ，有 49 个字段。

可以透過如下指令查看：

```sql
# 使用以下 SQL 指令來查詢這個資料表的欄位資訊：
DESCRIBE mysql.user;

# 或者使用更完整的
SHOW COLUMNS FROM mysql.user;

# 如果你想一次性看到欄位名稱，可以搭配 INFORMATION_SCHEMA 查詢：
SELECT COLUMN_NAME
FROM INFORMATION_SCHEMA.COLUMNS
WHERE TABLE_SCHEMA = 'mysql' AND TABLE_NAME = 'user';
```

> 这些字段可以分成4类，分别是范围列（或用户列）、权限列、安全列和资源控制列

### 3.2.1 範圍列(用戶列)
>「**MySQL 權限表中的範圍列（Scope Columns）**」，也就是用來限制 **誰可以連線進來、從哪裡連線、是否需要密碼驗證** 的核心欄位。在 MySQL 的權限表中，這些欄位主要存在於 `mysql.user` 表，是**身份驗證**與**權限範圍控制**的第一關。

---

#### 🔍 一、MySQL 權限表的範圍列（Scope Columns）

| 欄位名稱             | 作用說明 |
|----------------------|----------|
| `Host`               | 指定用戶連線的來源主機 |
| `User`               | 指定用戶名稱 |
| `authentication_string`（MySQL 5.7+） | 密碼加密後的儲存欄位（替代舊版的 `Password` 欄位） |

這三個欄位搭配起來，可以完整定義 **某個使用者從哪裡連線、是否允許連線、使用哪個密碼驗證**。

---

#### 🧠 二、Host 欄位的說明與範例

| Host 設定值      | 說明 |
|------------------|------|
| `'localhost'`    | 僅限從本地主機（127.0.0.1 或 ::1）連線。通常是命令列 `mysql -u user -p` |
| `'%'`            | 表示所有來源 IP 都可以連線（開放遠端） |
| `'192.168.1.2'`  | 僅允許此 IP 的主機連線 |
| `'server01'`     | 僅允許此主機名稱連線（依 DNS 名稱解析） |
| `'::1'`          | IPv6 的 localhost，相當於 127.0.0.1 |
| `'127.0.0.1'`    | IPv4 的本機地址（類似 localhost） |

🧪 **範例：建立兩個相同使用者但不同連線方式的帳號**

```sql
-- 只能本機登入
CREATE USER 'alice'@'localhost' IDENTIFIED BY 'pwd123';

-- 可以從任何地方遠端登入
CREATE USER 'alice'@'%' IDENTIFIED BY 'pwd123';
```

> 雖然是同樣的使用者名稱 `alice`，但因為 Host 欄位不同，所以是「兩個不同的帳號」。

---

#### 🧪 三、User 欄位：使用者帳號

- 為帳號名稱的主體（不能單獨使用，必須搭配 Host 才唯一）
- 同樣的名稱 `user`，在 `localhost` 與 `192.168.1.2` 是不同帳號

---

#### 🔒 四、Password / authentication_string

##### ✅ 舊版本（MySQL 5.6 以前）

```sql
SELECT User, Host, Password FROM mysql.user;
```

- 密碼使用 `PASSWORD()` 函式產生密文儲存到 `Password` 欄位
- 例如：`*94BDCEBE19083CE2A1F959FD02F964C7AF4CFC29`

---

##### ✅ 新版本（MySQL 5.7+）

```sql
SELECT User, Host, authentication_string FROM mysql.user;
```

- 不再使用 `Password` 欄位
- 改用 `authentication_string` 存密文
- 密碼驗證使用 plugin，例如：
  - `caching_sha2_password`（MySQL 8.0 預設）
  - `mysql_native_password`（舊相容性）

🧪 **範例：建立一個使用者並查看其加密方式**

```sql
CREATE USER 'bob'@'localhost' IDENTIFIED WITH mysql_native_password BY 'secret123';

SELECT user, host, plugin, authentication_string
FROM mysql.user
WHERE user = 'bob';
```

---

#### ✅ 五、實用命令與查詢

##### 查看所有帳號及其 Host
```sql
SELECT User, Host FROM mysql.user;
```

##### 查看帳號密碼使用的加密方式
```sql
SELECT User, Host, plugin, authentication_string FROM mysql.user;
```

---

#### ✅ 六、常見用途總結

| 使用場景                         | 建議設定                              |
|----------------------------------|----------------------------------------|
| 僅限內部伺服器訪問資料庫         | `'user'@'localhost'`                   |
| 開放多台特定伺服器使用           | `'user'@'192.168.%.%'` 或多筆記錄     |
| 遠端開放開發使用者連線           | `'user'@'%'`（但應加強密碼與防火牆） |
| 指定特定 IPv6 主機              | `'user'@'::1'`                         |

---

### 3.2.2 權限列
> 當我們談到 **MySQL 權限表中的權限列（Privilege Columns）**，指的是儲存在 `mysql.user`、`mysql.db` 等表中，表示每個使用者 **是否擁有某些特定操作權限** 的欄位。這些欄位的值通常是 `Y`（Yes）或 `N`（No），表示允許或不允許某項權限。

---

#### 🔐 一、權限列的意義與結構

權限列的格式如下：

| 欄位名稱         | 說明 |
|------------------|------|
| `Select_priv`    | 是否能執行 `SELECT` 查詢 |
| `Insert_priv`    | 是否能插入資料（`INSERT`） |
| `Update_priv`    | 是否能更新資料（`UPDATE`） |
| `Delete_priv`    | 是否能刪除資料（`DELETE`） |
| `Execute_priv`   | 是否能執行儲存程序或函數（`EXECUTE`） |
| `Super_priv`     | 是否擁有「超級使用者」權限（影響資料庫層級操作） |
| `Shutdown_priv`  | 是否能夠關閉 MySQL 伺服器 |
| `Grant_priv`     | 是否能將自己擁有的權限授予他人 |

這些欄位出現在不同的權限表中，依據其所屬層級決定其影響範圍：

| 權限表          | 欄位涵蓋層級     | 欄位樣例              |
|-----------------|------------------|------------------------|
| `mysql.user`     | 全域（全資料庫） | `Select_priv`、`Super_priv` 等 |
| `mysql.db`       | 特定資料庫       | `Insert_priv`、`Update_priv` 等 |
| `mysql.tables_priv` | 特定資料表   | `Table_priv` 欄位（如 `Select,Insert`） |
| `mysql.columns_priv`| 特定欄位     | `Column_priv` 欄位（如 `Update`） |
| `mysql.procs_priv`  | 特定儲存程序 | `Execute_priv` |

---

#### 🧠 二、重要權限欄位補充解釋

| 權限欄位       | 解釋與說明 |
|----------------|------------|
| `Grant_priv`   | 使用者是否可以使用 `GRANT` 將自己擁有的權限授權給其他帳號。 |
| `Shutdown_priv`| 是否可以關閉 MySQL 伺服器（等同於 root 管理員）。 |
| `Super_priv`   | 是否擁有超級權限：例如 KILL 其他連線、設定全域變數、跳過權限檢查。 |
| `Execute_priv` | 是否能執行 `CREATE PROCEDURE` 建立的儲存程序與函數。 |

---

#### 🧪 三、範例說明

##### ✅ 1. 檢查使用者擁有哪些權限
```sql
SELECT user, host, Select_priv, Insert_priv, Update_priv, Grant_priv
FROM mysql.user
WHERE user = 'alice';
```

---

##### ✅ 2. 建立使用者並授予部分權限
```sql
CREATE USER 'bob'@'localhost' IDENTIFIED BY '123456';

-- 給予查詢與新增權限
GRANT SELECT, INSERT ON mydb.* TO 'bob'@'localhost';

-- 給予 EXECUTE 權限（可執行儲存程序）
GRANT EXECUTE ON PROCEDURE mydb.my_proc TO 'bob'@'localhost';
```

📌這時，在 `mysql.db` 表中，`Select_priv` 與 `Insert_priv` 將是 `'Y'`，`Execute_priv` 將出現在 `mysql.procs_priv` 表中。

---

##### ✅ 3. 賦予 GRANT 權限
```sql
GRANT SELECT ON mydb.* TO 'bob'@'localhost' WITH GRANT OPTION;
```
📌 此舉會將 `Grant_priv` 欄位設為 `'Y'`，表示 `bob` 可將他的 `SELECT` 權限授與他人。

---

#### 📌 四、實用查詢與操作命令

##### 查看某使用者的所有權限
```sql
SHOW GRANTS FOR 'bob'@'localhost';
```

##### 查詢哪些使用者擁有 SUPER 權限
```sql
SELECT User, Host FROM mysql.user WHERE Super_priv = 'Y';
```

---

#### 🛠 五、權限欄位管理補充

| 權限類型 | 指令 |
|----------|------|
| 增加權限 | `GRANT ... TO user` |
| 撤銷權限 | `REVOKE ... FROM user` |
| 查看權限 | `SHOW GRANTS FOR user` |
| 更新權限表 | `FLUSH PRIVILEGES;`（當手動更新 mysql.user 時才需要） |

---

### 3.2.3 安全列
> 當我們談到 MySQL 權限表中的「**安全列（Security Columns）**」，主要是指用來**強化使用者身份驗證與連線安全性**的欄位，這些欄位主要存在於 `mysql.user` 表中，屬於進階的安全控制設定。

---

#### 🔐 一、MySQL 安全列總覽（6 個欄位）

| 欄位名稱           | 分類     | 功能說明 |
|--------------------|----------|----------|
| `ssl_type`         | SSL 加密 | 指定需要使用哪種 SSL 機制（例如：ANY、X509、SPECIFIED） |
| `ssl_cipher`       | SSL 加密 | 指定允許使用的 SSL 加密套件（cipher） |
| `x509_issuer`      | X.509 驗證 | 限定用戶端證書發行者 |
| `x509_subject`     | X.509 驗證 | 限定用戶端證書主體（如憑證擁有者） |
| `plugin`           | 身份驗證 | 指定此帳號使用的身份驗證外掛程式 |
| `authentication_string` | 身份驗證 | 儲存加密後的密碼（MySQL 5.7 之後不再使用 `password` 欄位） |

---

#### 🧠 二、各安全欄位詳細解釋與補充

##### ✅ 1. SSL 相關欄位（加密連線）

| 欄位         | 功能說明 |
|--------------|----------|
| `ssl_type`   | 控制此使用者是否需透過 SSL 連線。可選值：<br>• `''`（空值）：不強制 SSL<br>• `ANY`：需要 SSL 加密即可<br>• `X509`：需要 SSL 且檢查憑證<br>• `SPECIFIED`：需符合 `ssl_cipher`、`x509_subject`、`x509_issuer` |
| `ssl_cipher` | 指定允許的 SSL 加密演算法（例如 `DHE-RSA-AES256-SHA`） |

🧪 **範例**：設定使用者只能透過 SSL 加密連線

```sql
GRANT USAGE ON *.* TO 'secure_user'@'%' REQUIRE SSL;
```

等同於在 `mysql.user` 設定：
```sql
ssl_type = 'ANY'
```

---

##### ✅ 2. X.509 相關欄位（憑證身分識別）

| 欄位           | 功能說明 |
|----------------|----------|
| `x509_issuer`  | 指定連線者所用憑證的簽發機構（CA）名稱 |
| `x509_subject` | 指定連線者所用憑證的持有者名稱（例如：`CN=client,O=company`） |

🧪 **範例**：只能由指定機構發的憑證登入
```sql
GRANT USAGE ON *.* TO 'cert_user'@'%' 
REQUIRE SUBJECT '/CN=client/O=myorg' 
AND ISSUER '/C=TW/O=RootCA';
```

---

##### ✅ 3. Plugin 欄位（身份驗證機制）

| 欄位       | 功能說明 |
|------------|----------|
| `plugin`   | 指定使用哪個身份驗證外掛，例如：<br>• `mysql_native_password`<br>• `caching_sha2_password`（MySQL 8 預設）<br>• `sha256_password`（安全性更高） |
| `authentication_string` | 儲存密碼密文（由 plugin 生成） |

🧪 **範例 1**：建立使用 `mysql_native_password` 的帳號
```sql
CREATE USER 'bob'@'localhost'
IDENTIFIED WITH mysql_native_password BY 'mypwd';
```

🧪 **範例 2**：建立使用 `caching_sha2_password` 的帳號（MySQL 8 預設）
```sql
CREATE USER 'alice'@'localhost'
IDENTIFIED BY 'secure123';
```
等同於：
```sql
plugin = 'caching_sha2_password'
```

---

#### ✅ 三、查詢安全列資訊

```sql
SELECT user, host, plugin, ssl_type, ssl_cipher, x509_issuer, x509_subject
FROM mysql.user;
```

---

#### 📌 四、使用情境整理

| 使用場景 | 建議設定 |
|----------|----------|
| 要求使用者僅能透過 SSL 加密連線 | `ssl_type = 'ANY'` |
| 限制使用者必須使用特定憑證 | `ssl_type = 'SPECIFIED'` + `x509_*` 欄位 |
| 設定密碼驗證機制與加密強度 | 使用 `plugin` 欄位（如 `sha256_password`） |
| 加強密碼安全性與登入辨識 | 搭配 `authentication_string` 加密儲存 |

---

### 3.2.4 資源空置列
> 你提到的「**MySQL 權限表中的資源控制列（Resource Control Columns）**」，是用來**限制使用者在資料庫中耗用系統資源的上限**。這些限制可以有效防止某個帳號濫用資源，影響整體資料庫效能。

---

#### 🧩 一、資源控制欄位簡介

| 欄位名稱               | 說明 |
|------------------------|------|
| `max_questions`        | 使用者每小時最多能執行的查詢語句數（`SELECT`, `SHOW`, `DESCRIBE`...） |
| `max_updates`          | 每小時最多執行的更新語句數（`UPDATE`, `DELETE`, `INSERT`, `REPLACE`） |
| `max_connections`      | 每小時允許新建立的連線數（連線後登出再重連也算一次） |
| `max_user_connections` | 同一時間允許的並發連線數（而非每小時的累計） |

這些欄位都存在於 `mysql.user` 表中，並用來限制個別帳號的行為，**單位時間為小時**（除 `max_user_connections` 為即時限制）。

---

#### 🔐 二、實際應用情境

| 應用情境                             | 解決方案                     |
|--------------------------------------|------------------------------|
| 防止某開發者大量 `SELECT` 撐爆伺服器 | 設定 `max_questions`         |
| 限制某 API 使用者更新資料過頻繁     | 設定 `max_updates`           |
| 限制攻擊者暴力連線（DoS）           | 設定 `max_connections`       |
| 限制使用者同時開多個連線            | 設定 `max_user_connections`  |

---

#### 🧪 三、範例操作

##### ✅ 1. 建立使用者並限制每小時只能查詢 100 次
```sql
CREATE USER 'alice'@'localhost'
IDENTIFIED BY 'secure123'
WITH MAX_QUERIES_PER_HOUR 100;
```
此時 `mysql.user` 中 `max_questions = 100`

---

##### ✅ 2. 限制使用者每小時最多能更新 50 次
```sql
GRANT USAGE ON *.* TO 'bob'@'%'
WITH MAX_UPDATES_PER_HOUR 50;
```
此時 `max_updates = 50`

---

##### ✅ 3. 限制每小時最多允許建立連線 20 次
```sql
GRANT USAGE ON *.* TO 'charlie'@'%'
WITH MAX_CONNECTIONS_PER_HOUR 20;
```

---

##### ✅ 4. 限制使用者同時最多 3 條連線
```sql
GRANT USAGE ON *.* TO 'david'@'localhost'
WITH MAX_USER_CONNECTIONS 3;
```

---

##### ✅ 5. 查看使用者資源限制設定

```sql
SELECT user, host, max_questions, max_updates, max_connections, max_user_connections
FROM mysql.user
WHERE user = 'alice';
```

或格式化方式查看所有欄位：
```sql
SELECT * FROM mysql.user WHERE user = 'alice'\G
```

---

#### 🛠 四、變更現有使用者的限制

若想對已存在的使用者設定資源限制，使用 `ALTER USER`：

```sql
ALTER USER 'alice'@'localhost'
WITH
    MAX_QUERIES_PER_HOUR 200,
    MAX_UPDATES_PER_HOUR 100,
    MAX_CONNECTIONS_PER_HOUR 50,
    MAX_USER_CONNECTIONS 2;
```

---

#### 📌 五、注意事項

1. 這些資源限制是 **針對單一帳號** 設定，不會影響全體使用者。
2. 限制條件在每小時會自動重置（不需手動清除）。
3. `max_user_connections` 是即時限制，會立即阻止多開。
4. 若欄位值為 `0`（預設），代表不限制。

---

#### ✅ 小結表

| 欄位名稱             | 單位    | 控制什麼？ |
|----------------------|---------|------------|
| `max_questions`        | 每小時 | 查詢次數 |
| `max_updates`          | 每小時 | 更新次數（INSERT/UPDATE/DELETE） |
| `max_connections`      | 每小時 | 建立連線次數 |
| `max_user_connections` | 即時   | 同時連線數 |

---

## 3.3 db表
### 🔐 一、MySQL `db` 權限表用途說明

`db` 表是 MySQL 中一張關鍵的權限控制表，位置在 `mysql` 系統資料庫中：  
```
mysql.db
```

這張表的作用是：  
> **定義某使用者對特定資料庫的操作權限，並限定該使用者從哪個主機登入。**

---

### 🔧 二、db 表的欄位結構與功能分類

你提到的分類是正確的，可以再進一步補充如下：

#### ✅ 1. 使用者列（3個欄位，構成主鍵）

| 欄位名 | 說明 |
|--------|------|
| `Host` | 可登入的主機，例如 `'localhost'`、`'%'`、特定 IP |
| `User` | 使用者帳號，例如 `'testuser'` |
| `Db`   | 權限適用的資料庫名稱，例如 `'finance_db'` |

> 🔸 **這三個欄位構成主鍵**，決定權限條件：「從某主機登入的某使用者對某資料庫的權限」。

---

#### ✅ 2. 權限列（多個欄位）

以下是常見的權限欄位（值為 `'Y'` 或 `'N'`）：

| 欄位名 | 說明 |
|--------|------|
| `Select_priv`       | 查詢權限（`SELECT`） |
| `Insert_priv`       | 新增資料權限（`INSERT`） |
| `Update_priv`       | 更新資料權限（`UPDATE`） |
| `Delete_priv`       | 刪除資料權限（`DELETE`） |
| `Create_priv`       | 建立資料表或資料庫 |
| `Drop_priv`         | 刪除資料表或資料庫 |
| `Grant_priv`        | 是否可授權權限給他人 |
| `References_priv`   | 外鍵參考權限 |
| `Index_priv`        | 建立索引權限 |
| `Alter_priv`        | 修改資料表結構 |
| `Create_tmp_table_priv` | 建立暫時表 |
| `Lock_tables_priv`  | 鎖定資料表 |
| `Create_view_priv`  | 建立檢視表 |
| `Show_view_priv`    | 查看檢視表定義 |
| `Create_routine_priv` | 建立儲存程序（如你提到） |
| `Alter_routine_priv`  | 修改儲存程序 |
| `Execute_priv`      | 執行儲存程序或函式 |

---

### 🔍 三、查看 db 權限表的欄位結構

```sql
DESC mysql.db;
```

或用 `SHOW COLUMNS`：

```sql
SHOW COLUMNS FROM mysql.db;
```

---

### 📌 四、查詢目前 db 表中的設定

```sql
SELECT Host, User, Db, Select_priv, Insert_priv, Update_priv, Delete_priv 
FROM mysql.db\G
```

---

### 🧪 五、範例情境說明

#### 🎯 情境：我想讓使用者 `report_user` 僅能從 `192.168.0.10` 存取 `finance_db` 資料庫，並只能進行查詢與更新。

##### 步驟 1：建立帳號（user 表）
```sql
CREATE USER 'report_user'@'192.168.0.10' IDENTIFIED BY 'pass123';
```

##### 步驟 2：先設 user 表的全域權限為 N（預設不授權）
（這一步可以省略，MySQL 預設 user 權限為 N）

##### 步驟 3：直接插入 db 權限表
```sql
INSERT INTO mysql.db 
(Host, User, Db, Select_priv, Insert_priv, Update_priv, Delete_priv, Create_priv, Drop_priv, Grant_priv, References_priv, Index_priv, Alter_priv, Create_tmp_table_priv, Lock_tables_priv, Create_view_priv, Show_view_priv, Create_routine_priv, Alter_routine_priv, Execute_priv)
VALUES
('192.168.0.10', 'report_user', 'finance_db', 'Y', 'N', 'Y', 'N', 'N', 'N', 'N', 'N', 'N', 'N', 'N', 'N', 'N', 'N', 'N', 'N', 'N');
```

##### 步驟 4：重新加載權限
```sql
FLUSH PRIVILEGES;
```

---

### ✅ 六、權限驗證流程補充說明

MySQL 判斷某使用者的權限時，會依序檢查：

1. `user` 表：是否具有全域權限（針對 * 所有資料庫）
2. `db` 表：是否具有某個資料庫的權限（針對某個資料庫）
3. `tables_priv`、`columns_priv`、`procs_priv` 表：更細的資料表、欄位或儲存程序權限

> ✅ 如果 user 表中設為 Y，則即使 db 表中沒有設，也一樣有該權限。  
> ❌ 如果 user 表中設為 N，就要在 db 表中設定該權限，否則會被拒絕。

---

## 3.4 tables_priv表和columns_priv表

### ✅ 一、`tables_priv` 表：針對「資料表」級別的操作權限

#### 1. 用途
- 控制使用者對 **某張資料表** 的操作權限，例如 `SELECT`、`INSERT`、`DELETE` 等。
- 權限粒度比 `db` 表更細，可指定到表，而非整個資料庫。

#### 2. 欄位說明（共 8 個）

| 欄位名 | 說明 |
|--------|------|
| `Host`        | 主機名稱（與 user 表一致，例如 `%`, `localhost`） |
| `Db`          | 資料庫名稱（如 `sales_db`） |
| `User`        | 使用者帳號 |
| `Table_name`  | 欲賦權的資料表名稱 |
| `Grantor`     | 指定這筆記錄是誰授權的（格式如 `'root@localhost'`） |
| `Timestamp`   | 記錄變更時間（自動維護） |
| `Table_priv`  | 資料表層級的操作權限（**以逗號分隔的字串**） |
| `Column_priv` | 對資料表欄位的權限（僅支援 `Select, Insert, Update, References`） |

#### ✅ `Table_priv` 權限選項：
| 權限 | 說明 |
|------|------|
| `Select`     | 查詢表資料 |
| `Insert`     | 新增資料 |
| `Update`     | 更新資料 |
| `Delete`     | 刪除資料 |
| `Create`     | 建立表 |
| `Drop`       | 刪除表 |
| `Grant`      | 授權權限 |
| `References` | 參考（用於外鍵） |
| `Index`      | 操作索引 |
| `Alter`      | 修改表結構 |

---

### ✅ 二、`columns_priv` 表：針對「欄位」級別的操作權限

#### 1. 用途
- 控制使用者對資料表中 **某個欄位** 的操作，例如只能讀取 `name` 欄位，但不能查詢 `salary`。

#### 2. 欄位說明（共 6 個）

| 欄位名 | 說明 |
|--------|------|
| `Host`        | 主機名稱 |
| `Db`          | 資料庫名稱 |
| `User`        | 使用者帳號 |
| `Table_name`  | 欲控制的資料表名稱 |
| `Column_name` | 欲控制的欄位名稱 |
| `Column_priv` | 欄位級別權限：`Select`, `Insert`, `Update`, `References` |

---

### 🔄 三、權限驗證順序補充

MySQL 在授權檢查時會依序查詢：

1. `user` 表（是否有全域權限）
2. `db` 表（某資料庫層級）
3. `tables_priv` 表（某表層級）
4. `columns_priv` 表（某欄位層級）

系統會選擇「**最細粒度的設定優先**」，例如：
- 若 `user` 表未給 Select 權限，但 `columns_priv` 中針對某欄位給了 `Select`，則只可查那一欄。

---

## 3.5 procs_priv表
### 🔐 一、什麼是 `procs_priv` 表？

`procs_priv` 是 MySQL 中的一張系統權限表，**專門用來定義某使用者對某個儲存過程（Stored Procedure）或函數（Function）的存取權限**，屬於「程序級」權限控管。

> 📌 若你需要對單一儲存程序設定誰能執行、修改，就要靠這張表！

---

### 🧩 二、表結構說明：`DESC mysql.procs_priv`

```sql
DESC mysql.procs_priv;
```

| 欄位名稱         | 說明 |
|------------------|------|
| `Host`           | 主機名（例如 `%`, `localhost`） |
| `Db`             | 資料庫名稱 |
| `User`           | 使用者名稱 |
| `Routine_name`   | 儲存過程或函式的名稱 |
| `Routine_type`   | 類型：`PROCEDURE` 或 `FUNCTION` |
| `Grantor`        | 授權者（格式：'root@localhost'） |
| `Proc_priv`      | 權限類型，以逗號分隔的字串 |
| `Timestamp`      | 最後修改時間（自動維護） |

---

### 🧾 三、`Proc_priv` 欄位可設的權限有哪些？

| 權限 | 說明 |
|------|------|
| `Execute`     | 允許執行儲存程序或函數 |
| `Alter Routine` | 允許修改儲存程序或函數 |
| `Grant`       | 允許再將權限授予其他使用者 |

> 權限以逗號分隔，例如：`'Execute,Alter Routine'`

---

### 🧪 四、實作範例

#### 🎯 目標
建立一個儲存程序 `get_sales_data()`，讓使用者 `user02` 僅能執行（不能修改）此儲存程序。

---

#### 步驟 1：建立範例儲存程序
```sql
USE sales_db;

DELIMITER //
CREATE PROCEDURE get_sales_data()
BEGIN
  SELECT * FROM orders LIMIT 10;
END;
//
DELIMITER ;
```

---

#### 步驟 2：建立使用者帳號
```sql
CREATE USER 'user02'@'localhost' IDENTIFIED BY 'pass123';
```

---

#### 步驟 3：授權「執行」該儲存程序（會自動更新 `procs_priv` 表）
```sql
GRANT EXECUTE ON PROCEDURE sales_db.get_sales_data TO 'user02'@'localhost';
```

---

#### 步驟 4：查看 `procs_priv` 權限表內容
```sql
SELECT * FROM mysql.procs_priv\G
```

結果會看到：
```text
Host: localhost
Db: sales_db
User: user02
Routine_name: get_sales_data
Routine_type: PROCEDURE
Grantor: 'root@localhost'
Proc_priv: Execute
Timestamp: 2025-04-17 16:00:00
```

---

#### 步驟 5：用 user02 測試執行儲存程序
```sql
CALL sales_db.get_sales_data(); -- ✅ 可以執行
```

若嘗試修改該儲存程序（例如 ALTER），會出現：
```sql
ERROR 1044 (42000): Access denied for user 'user02'@'localhost' to database 'sales_db'
```

---

### 🧠 小提醒

- 如果你對某使用者用 `GRANT EXECUTE ON FUNCTION xxx TO ...`，也會在 `procs_priv` 中新增一筆對應的 `FUNCTION` 權限。
- `procs_priv` 的優先權高於 `db` 表中針對整個資料庫的執行權限。
- 若你在 `user` 或 `db` 表中授予了 `Execute` 權限，該使用者可執行所有該層級的儲存程序，不需要再設 `procs_priv`。

---

# 4. 访问控制
## 4.1 概述
### 🔐 MySQL 訪問控制簡介

MySQL 的訪問控制機制旨在**保護資料庫資源**不被未經授權的使用者存取或操作。它主要依靠**帳號、密碼、來源 IP 以及權限設定**來進行控管。

---

### 📋 訪問控制的兩個階段

#### **1. 連線核實階段（Connection Verification Phase）**
這是第一道防線。

當用戶端試圖連線到 MySQL 伺服器時，MySQL 會根據下列條件驗證使用者：

- **使用者名稱（username）**
- **主機名稱或 IP（host）**
- **密碼（password）**

🔍 MySQL 會在 `mysql.user` 資料表中尋找是否有相符的使用者資訊。如果沒有相符的帳號或密碼錯誤，**連線會被拒絕**。

---

#### **2. 請求核實階段（Request Verification Phase）**
這是第二道防線。

一旦連線成功，用戶就可以發送各種 SQL 指令（如 SELECT、INSERT、DELETE...），此時 MySQL 會檢查這個帳號是否有足夠的權限執行該操作。

🔍 權限資訊分別儲存在如：

- `mysql.user`：全域權限（如是否能建立新資料庫）
- `mysql.db`：資料庫層級的權限
- `mysql.tables_priv`：資料表層級的權限
- `mysql.columns_priv`：欄位層級的權限

---

### 🧪 範例說明

#### 🎯 目標
讓一個使用者 `report_user` 只能查詢（SELECT）`reporting_db` 資料庫中的 `sales_report` 資料表，不能修改資料。

#### 步驟

```sql
-- 1. 建立使用者
CREATE USER 'report_user'@'localhost' IDENTIFIED BY 'strongpassword';

-- 2. 賦予 SELECT 權限
GRANT SELECT ON reporting_db.sales_report TO 'report_user'@'localhost';

-- 3. 應用權限變更
FLUSH PRIVILEGES;
```

#### ✅ 使用者可以做的事：
```sql
-- 可以查詢資料
SELECT * FROM reporting_db.sales_report;
```

#### ❌ 使用者不能做的事：
```sql
-- 嘗試插入資料（會失敗）
INSERT INTO reporting_db.sales_report VALUES (...);
```

---

### 🔍 補充：權限層級說明

| 權限類型         | 作用範圍                     | 說明                          |
|------------------|------------------------------|-------------------------------|
| 全域權限         | 作用於所有資料庫             | 如：GRANT ALL ON *.*          |
| 資料庫層級權限   | 作用於特定資料庫             | 如：GRANT SELECT ON db_name.* |
| 資料表層級權限   | 作用於特定資料表             | 如：GRANT SELECT ON db.table  |
| 欄位層級權限     | 作用於資料表的特定欄位       | 如：GRANT SELECT (col1)       |
| 執行程序權限     | 執行某些儲存程序、函式、事件 | 如：GRANT EXECUTE ON PROCEDURE foo |

---

### 🧠 小結

- **訪問控制是 MySQL 的核心安全機制之一**
- 包含 **帳號驗證**（連線核實）與 **操作授權**（請求核實）
- 可根據需求設計出**細緻的權限控管策略**
- 使用 `GRANT` 與 `REVOKE` 可動態設定權限

---

## 4.2 連接核實階段
### ✅ 一、補充解釋：「連接核實階段」

MySQL 的連接驗證是在客戶端「還沒開始執行 SQL 指令」前進行的，主要是根據帳號與來源主機是否被允許連接。

#### 🔍 驗證依據的三個欄位（在 `mysql.user` 表中）：

| 欄位名稱               | 說明 |
|------------------------|------|
| `Host`                 | 指定可從哪些主機連進來（可以是 IP、主機名、% 萬用字元） |
| `User`                 | 使用者帳號名稱 |
| `authentication_string` | 儲存加密後的密碼（舊版 MySQL 是 `Password` 欄位）|

#### ✅ 通過條件：

當你用 MySQL 客戶端嘗試連線時，MySQL 會執行下列邏輯：

```sql
SELECT * 
FROM mysql.user 
WHERE 
    Host = '<來源 IP 或主機名>' 
    AND User = '<使用者名稱>';
```

如果找到記錄，且提供的密碼經過 hash 後比對成功，就**通過連線核實階段**，否則就會被拒絕。

---

### 💡 二、常見現象與說明

#### 📌 1. 錯誤訊息 `Access denied for user`
這通常是連線核實失敗，例如帳號、密碼、主機不符。

#### 📌 2. Host 欄位設定錯誤
MySQL 有時會區分：
- `'user'@'localhost'`：只能從本機登入
- `'user'@'%'`：允許從任何主機登入（常用於遠端）
- `'user'@'192.168.1.%'`：允許從特定內網登入

---

### 🧪 三、實作範例說明

#### 🎯 目標：
建立一個帳號 `app_user`，僅允許從特定內網（例如 `192.168.10.%`）登入，並設置密碼。

```sql
-- 建立使用者，僅限於特定 IP 網段
CREATE USER 'app_user'@'192.168.10.%' IDENTIFIED BY 'securePass123';
```

#### 🚫 嘗試從錯誤 IP 連線
假設你從 `192.168.11.5` 嘗試連線：

```bash
mysql -u app_user -p -h 192.168.11.5
```

你會得到：
```text
ERROR 1045 (28000): Access denied for user 'app_user'@'192.168.11.5'
```

因為 `Host='192.168.11.5'` 不符合你設定的 `192.168.10.%`。

---

### 🧰 補充技巧：檢查使用者權限和連線設定

```sql
-- 檢查指定使用者的連線來源
SELECT Host, User FROM mysql.user WHERE User = 'app_user';

-- 顯示目前使用者的權限
SHOW GRANTS FOR 'app_user'@'192.168.10.%';
```

---

### ✅ 總結

| 項目 | 說明 |
|------|------|
| 驗證內容 | 使用者名稱 (`User`)、主機來源 (`Host`)、密碼 (`authentication_string`) |
| 驗證資料表 | `mysql.user` |
| 驗證結果 | 成功：進入第二階段；失敗：直接拒絕連線 |
| 常見錯誤 | `Access denied` 通常與 Host 配置或密碼錯誤有關 |

---

## 4.3 請求核實階段
### ✅ 一、請求核實階段補充說明

當使用者成功連上 MySQL 後，**每一個 SQL 請求**都要經過一次**權限驗證**，確保該用戶是否有**執行此操作的權限**。

#### 🔍 權限驗證從高到低依序查詢以下資料表：

| 欄位順序         | 權限層級   | 表格名稱           | 權限範圍                 |
|------------------|------------|---------------------|--------------------------|
| 第一層 | 全域 (global)     | `mysql.user`         | 所有資料庫與所有資料表       |
| 第二層 | 資料庫 (database) | `mysql.db`           | 指定資料庫中的所有資料表     |
| 第三層 | 資料表 (table)    | `mysql.tables_priv`  | 指定資料庫中的特定資料表     |
| 第四層 | 欄位 (column)     | `mysql.columns_priv` | 指定資料表中的特定欄位       |

🧠 重點邏輯：**MySQL 一旦找到足夠的權限就不會繼續往下找**，但如果在上層找不到，它才會往下一層查詢。

---

### 🧪 二、具體範例說明

#### 🎯 目標情境：
建立一個使用者 `audit_user`，只允許查詢（SELECT）`finance_db` 資料庫中的 `expense_report` 資料表中的 `year`, `amount` 兩個欄位。

#### 步驟拆解與權限設定：

##### 1️⃣ 建立使用者
```sql
CREATE USER 'audit_user'@'localhost' IDENTIFIED BY 'securePass456';
```

##### 2️⃣ 不給任何 user 層級權限（預設即可）
（此時 `mysql.user` 中沒有 SELECT 權限）

##### 3️⃣ 不給任何資料庫層級權限
```sql
-- 不給予 GRANT SELECT ON finance_db.*
```

##### 4️⃣ 不給資料表層級權限
```sql
-- 也不給 GRANT SELECT ON finance_db.expense_report
```

##### 5️⃣ 只給「欄位層級」權限（mysql.columns_priv）
```sql
GRANT SELECT (year, amount) 
ON finance_db.expense_report 
TO 'audit_user'@'localhost';
```

##### ✅ 驗證行為

```sql
-- 成功查詢指定欄位
SELECT year, amount FROM finance_db.expense_report;

-- 錯誤：嘗試查詢未授權欄位（例如部門名稱）
SELECT department FROM finance_db.expense_report;
-- -> ERROR 1143 (42000): SELECT command denied to user ...
```

---

### 🧠 三、實務上的使用建議

| 權限層級   | 使用時機                                  |
|------------|-------------------------------------------|
| `user`     | 管理員帳號、或允許跨資料庫操作的帳號      |
| `db`       | 應用程式帳號、操作特定資料庫              |
| `table`    | 精細權限控管：例如帳號只能操作特定資料表  |
| `column`   | 資料分級存取：帳號只能看特定敏感欄位       |

---

### 🛠 權限查詢與移除

#### 查看目前帳號權限
```sql
SHOW GRANTS FOR 'audit_user'@'localhost';
```

#### 移除欄位權限
```sql
REVOKE SELECT (year, amount)
ON finance_db.expense_report
FROM 'audit_user'@'localhost';
```

---

### ✅ 小結

| 階段 | 說明 |
|------|------|
| 連線核實 | 驗證帳號/來源/密碼 |
| 請求核實 | 驗證該帳號是否有執行 SQL 操作的權限（user → db → table → column） |
| 權限層級 | 一層層往下查，但只要找到就停止；未找到就報錯拒絕操作 |

---

# 5. 角色管理
## 5.1 🔐 角色的理解
### 🔐 MySQL 角色管理補充說明

#### 1. 為什麼需要角色？
在 MySQL 8.0 之前，所有權限都直接賦予使用者。如果多位使用者需要相同的權限（例如財務部門人員），則每位使用者都必須分別授權，**不易管理也容易遺漏**。

有了角色功能後，你可以：
- 建立一個「角色（Role）」
- 將一組權限賦予角色
- 再將角色賦予使用者

![](./images/2402456-20220611162516856-1934485725.png "")

這樣一來，當要變更權限時，只需改動角色，而**不需一一調整所有使用者**，更具彈性與可維護性。

---

#### 2. 常用角色管理指令

| 操作類型           | 指令語法                                        |
|--------------------|------------------------------------------------|
| 創建角色           | `CREATE ROLE 'role_name';`                     |
| 指派權限給角色     | `GRANT privilege ON db.table TO 'role_name';`  |
| 創建使用者         | `CREATE USER 'user_name'@'host';`              |
| 指派角色給使用者   | `GRANT 'role_name' TO 'user_name'@'host';`     |
| 啟用角色           | `SET DEFAULT ROLE 'role_name' TO 'user_name';` |
| 使用者啟用角色     | `SET ROLE 'role_name';`                        |
| 查看角色           | `SELECT * FROM information_schema.applicable_roles WHERE grantee = CURRENT_USER;` |
| 刪除角色           | `DROP ROLE 'role_name';`                       |

---

#### 3. 實戰範例說明

##### 📌 需求：
假設有一組「財務部門」的使用者，他們需要查詢財務資料表，但不能修改資料。

---

##### 步驟一：建立角色
```sql
CREATE ROLE 'finance_reader';
```

---

##### 步驟二：賦予查詢權限
```sql
GRANT SELECT ON accounting_db.financial_reports TO 'finance_reader';
```

---

##### 步驟三：建立使用者
```sql
CREATE USER 'alice'@'localhost' IDENTIFIED BY 'Alice123!';
CREATE USER 'bob'@'localhost' IDENTIFIED BY 'Bob123!';
```

---

##### 步驟四：賦予角色給使用者
```sql
GRANT 'finance_reader' TO 'alice'@'localhost';
GRANT 'finance_reader' TO 'bob'@'localhost';
```

---

##### 步驟五：設定預設角色（登入即啟用）
```sql
SET DEFAULT ROLE 'finance_reader' TO 'alice'@'localhost';
SET DEFAULT ROLE 'finance_reader' TO 'bob'@'localhost';
```

---

##### 步驟六：檢查權限（登入後）
```sql
SHOW GRANTS FOR 'alice'@'localhost';
```

---

#### 4. 實務管理建議

- 建議以部門、職能或系統模塊來劃分角色，例如：`hr_reader`、`sales_manager`、`admin_ops`。
- 使用 `REVOKE` 可撤除角色或權限。
- 配合 `SHOW GRANTS` 和 `INFORMATION_SCHEMA` 資料表觀察角色指派情形。

---

#### ✅ 小結

| 優點                             | 效果                                                         |
|----------------------------------|--------------------------------------------------------------|
| 權限集中管理                     | 所有變更集中在角色本身進行                                   |
| 降低維護成本                     | 大量使用者權限可一次性統一配置                               |
| 強化安全控制                     | 簡化權限審核流程，便於符合公司資訊安全政策                   |
| 提升靈活性與擴展性               | 未來若要給新系統賦權，只需針對角色，不需一一處理使用者帳號 |

---

## 5.2 🧱 创建角色
### 🧱 MySQL 角色管理補充：**創建角色**

#### 🔹 為什麼要創建角色？
在企業或開發場景中，不同職位會對資料庫有不同的操作需求，例如：

- 業務人員只能查詢訂單
- 經理可以新增或修改產品資訊
- 資訊主管擁有最高權限

如果你直接給每個使用者分配權限，一旦權限規則改變（例如：經理新增了能刪除的權限），你就必須**逐一修改所有經理帳戶的權限，既麻煩又易出錯**。

使用角色（role），就能解決這個問題：
- 只需更新一次角色的權限，所有擁有該角色的使用者即自動更新！

---

#### 🔸 語法回顧
```sql
CREATE ROLE 'role_name'[@'host_name'];
```

- `role_name`：角色名稱，命名規則與使用者相同
- `host_name`：可選，預設為 `%`，表示任意主機登入
- 可一次建立多個角色，用逗號分隔

---

### 🧪 範例練習：創建不同職位的角色

#### 1️⃣ 創建「經理」角色
```sql
CREATE ROLE 'manager'@'localhost';
```

#### 2️⃣ 創建多個角色
```sql
CREATE ROLE 'sales'@'localhost', 'hr', 'admin';
```
> `hr` 的 host_name 預設為 `%`，等同於 `'hr'@'%'`

#### 3️⃣ 查看是否創建成功
```sql
SELECT * FROM mysql.roles_mapping;
```
> 此表中記錄了角色與使用者之間的映射關係。

---

### 🧩 實戰補充：配合授權與使用者示範

#### ✅ 給角色授權
假設 `manager` 角色需要能夠查詢與更新 `products` 資料表：
```sql
GRANT SELECT, UPDATE ON shop_db.products TO 'manager'@'localhost';
```

#### ✅ 創建使用者並賦予角色
```sql
CREATE USER 'alice'@'localhost' IDENTIFIED BY 'Alice123!';
GRANT 'manager'@'localhost' TO 'alice'@'localhost';
```

#### ✅ 設定預設角色（使用者登入後自動啟用）
```sql
SET DEFAULT ROLE 'manager'@'localhost' TO 'alice'@'localhost';
```

---

### 🧾 小結：角色創建實務建議

| 建議項目         | 說明                                                                 |
|------------------|----------------------------------------------------------------------|
| 命名清楚         | 建議以部門/職能命名，如 `finance_read`, `dev_ops`, `product_admin` |
| 限定 host_name   | 針對內部應用建議指定 `localhost`，避免風險                          |
| 一律先建立角色   | 再給角色授權，最後賦予使用者，維持一致性                          |

---

## 5.3 🧩 給角色賦予權限
### 🔹 1. 給角色賦予權限

當角色建立後，下一步就是賦予角色具體的權限，例如查詢（SELECT）、插入（INSERT）、更新（UPDATE）等。

#### ✅ 語法：
```sql
GRANT 權限類型 ON 資料庫.資料表 TO 'role_name'@'host_name';
```

#### 📌 範例：
讓 `manager` 角色擁有對 `company.employees` 資料表的查詢與修改權限：
```sql
GRANT SELECT, UPDATE ON company.employees TO 'manager'@'localhost';
```

---

### 🔹 2. 指派角色給使用者

接著，我們可以把已經設好權限的角色賦予給使用者。

#### ✅ 語法：
```sql
GRANT 'role_name'@'host_name' TO 'user_name'@'host_name';
```

#### 📌 範例：
將 `manager` 角色賦予 `alice` 使用者：
```sql
GRANT 'manager'@'localhost' TO 'alice'@'localhost';
```

---

### 🔹 3. 設定預設角色（使用者登入時自動啟用）

如果希望使用者登入後能自動啟用某個角色，需使用 `SET DEFAULT ROLE` 設定。

#### ✅ 語法：
```sql
SET DEFAULT ROLE 'role_name'@'host_name' TO 'user_name'@'host_name';
```

#### 📌 範例：
```sql
SET DEFAULT ROLE 'manager'@'localhost' TO 'alice'@'localhost';
```

> 若不設預設角色，使用者每次登入後要用 `SET ROLE` 手動啟用。

---

### 🔹 4. 使用者登入後啟用角色（非預設角色時）

若有多個角色，或不是預設角色，可使用 `SET ROLE` 在登入後切換角色。

#### ✅ 範例：
```sql
SET ROLE 'manager'@'localhost';
```

---

### 🔹 5. 撤銷角色或權限

#### 🔸 撤銷某個角色的某些權限：
```sql
REVOKE SELECT ON company.employees FROM 'manager'@'localhost';
```

#### 🔸 撤銷使用者的角色：
```sql
REVOKE 'manager'@'localhost' FROM 'alice'@'localhost';
```

---

### 🔹 6. 刪除角色

如果角色不再需要，可以刪除角色。

#### ✅ 語法：
```sql
DROP ROLE 'role_name'@'host_name';
```

#### 📌 範例：
```sql
DROP ROLE 'manager'@'localhost';
```

---

### 📝 完整範例：建立角色並賦予權限給使用者

```sql
-- 步驟 1：建立角色
CREATE ROLE 'sales'@'localhost';

-- 步驟 2：給角色賦予查詢產品資料表的權限
GRANT SELECT ON shop.products TO 'sales'@'localhost';

-- 步驟 3：建立使用者
CREATE USER 'bob'@'localhost' IDENTIFIED BY 'Bob123!';

-- 步驟 4：將角色賦予使用者
GRANT 'sales'@'localhost' TO 'bob'@'localhost';

-- 步驟 5：設定預設角色
SET DEFAULT ROLE 'sales'@'localhost' TO 'bob'@'localhost';
```

這樣 `bob` 登入後就會自動擁有 `sales` 角色的查詢權限。

---

如果你需要測試角色是否生效，可以登入後執行：
```sql
SHOW GRANTS;
SELECT * FROM shop.products;
```

---

## 5.4 🔍 查看角色的权限
### 📘 說明：

MySQL 中可以透過 `SHOW GRANTS FOR` 來檢視特定使用者或角色所擁有的權限，這是管理與驗證權限設定是否正確的重要方式。

---

### 📌 指令語法：

```sql
SHOW GRANTS FOR '角色名稱'@'主機名稱';
```

- 若主機名稱未指定，MySQL 會預設為 `%`
- 此語句會列出該角色目前擁有的所有權限

---

### 🧪 範例：查看角色 `manager` 的權限

```sql
SHOW GRANTS FOR 'manager'@'%';
```

執行結果範例如下：

```
+---------------------------------------------------------------------+
| Grants for manager@%                                               |
+---------------------------------------------------------------------+
| GRANT USAGE ON *.* TO `manager`@`%`                                |
| GRANT SELECT ON `demo`.`goodsmaster` TO `manager`@`%`              |
| GRANT SELECT ON `demo`.`invcount` TO `manager`@`%`                 |
| GRANT SELECT ON `demo`.`settlement` TO `manager`@`%`               |
+---------------------------------------------------------------------+
```

---

### 📝 結果解析：

| 欄位內容                                                | 意義說明 |
|---------------------------------------------------------|----------|
| `GRANT USAGE ON *.* TO manager@%`                       | 基本登入權限（系統自動給予） |
| `GRANT SELECT ON demo.goodsmaster TO manager@%`         | 可查詢商品主檔表（goodsmaster） |
| `GRANT SELECT ON demo.invcount TO manager@%`            | 可查詢盤點表（invcount） |
| `GRANT SELECT ON demo.settlement TO manager@%`          | 可查詢結算資訊表（settlement） |

✅ **這表示 manager 這個角色目前具有對 demo 資料庫中三個表格的查詢權限。**

> 只要你创建了一个角色，系统就会自动给你一个 **USAGE** 权限，意思是连接登录数据库的权限。代码的最后三行代表了我们给角色 **manager** 赋予的权限，也就是对商品信息表、盘点表和应付账款表的只读权限。

---

### 🔐 進一步補充：也可以查看使用者繼承的角色權限

假設你想確認某位使用者是否繼承了角色的權限，可以先查：
```sql
-- 查看使用者當前啟用的角色
SELECT CURRENT_ROLE();

-- 或直接看完整的使用者權限（包含角色帶來的）
SHOW GRANTS FOR 'alice'@'localhost';
```

---

### 🔄 動態檢查多個角色

若有多個角色，可搭配 `INFORMATION_SCHEMA.APPLICABLE_ROLES` 查詢使用者擁有的所有角色：

```sql
SELECT * FROM information_schema.applicable_roles
WHERE grantee = "'alice'@'localhost'";
```

---

### 🧾 整體小結

| 操作 | 用途 |
|------|------|
| `SHOW GRANTS FOR 'role'@'host';` | 查看某角色的所有權限 |
| `SHOW GRANTS FOR 'user'@'host';` | 查看某使用者的所有權限（包含角色授權） |
| `SELECT CURRENT_ROLE();`         | 查看當前啟用的角色 |
| `information_schema.applicable_roles` | 查看某使用者擁有哪些角色 |

---

## 5.5 🔄 回收角色的權限
### 📘 說明：

MySQL 允許透過 `REVOKE` 語句來**移除已授予角色的權限**。  
⚠️ 注意：**只要角色的權限被更動，所有擁有該角色的使用者權限也會同步受到影響**，這也是角色機制的重要特色之一 —— 集中控管權限。

---

### 🧾 基本語法：

```sql
REVOKE 權限類型 ON 資料庫.資料表 FROM '角色名稱'@'主機名稱';
```

- `權限類型`：如 `SELECT`、`UPDATE`、`DELETE` 等
- `FROM` 後面要指定角色（不是使用者）

---

### 🧪 範例 1：回收角色對單一資料表的查詢權限

假設你之前授予角色 `manager` 可查詢 `demo.settlement` 表：

```sql
GRANT SELECT ON demo.settlement TO 'manager'@'%';
```

現在你想 **撤銷這個查詢權限**：

```sql
REVOKE SELECT ON demo.settlement FROM 'manager'@'%';
```

執行後，所有使用 `manager` 角色的使用者都會失去該表的查詢權限。

---

### 🧪 範例 2：回收多個權限

如果角色有多種權限，也可以一次性撤回：

```sql
REVOKE SELECT, UPDATE ON demo.goodsmaster FROM 'manager'@'%';
```

這會撤銷 `manager` 在 `demo.goodsmaster` 上的查詢與修改權限。

---

### 🧩 實務操作建議：

| 操作時機 | 實務建議 |
|----------|-----------|
| 某角色不再需要某項權限時 | 使用 `REVOKE` 撤回，避免濫用權限 |
| 角色錯誤被授予權限時     | 立即使用 `REVOKE` 修正授權錯誤 |
| 權限政策變動              | 調整角色權限比調整每個使用者更有效率 |

---

### 🔐 補充：REVOKE 也可撤回使用者的角色

你也可以用 `REVOKE` 移除使用者對某角色的擁有權：

```sql
REVOKE 'manager'@'%' FROM 'alice'@'localhost';
```

這樣 `alice` 就不再擁有 `manager` 這個角色了。

---

### 📋 小總結：

| 指令                             | 功能                                   |
|----------------------------------|----------------------------------------|
| `REVOKE SELECT ON table FROM role` | 撤銷角色對某表的查詢權限               |
| `REVOKE UPDATE ON table FROM role` | 撤銷角色對某表的修改權限               |
| `REVOKE role FROM user`            | 移除使用者對角色的擁有權               |

---

## 5.6 🗑️ 刪除角色
### 📘 說明：

當你的資料庫系統經過**權限重整、部門調整、架構優化**後，某些角色可能已經不再需要。此時，就可以使用 `DROP ROLE` 指令來刪除不再使用的角色，避免權限管理混亂。

---

### 🔸 語法結構：

```sql
DROP ROLE 'role_name'[@'host'], 'role2'[@'host'], ...;
```

- 可同時刪除多個角色，使用逗號分隔
- 若未指定 host，預設為 `%`

---

### ⚠️ 注意事項：

1. 刪除角色後，**所有使用者會立刻失去該角色所帶來的所有權限**  
2. 被刪除的角色也會從 `mysql.roles_mapping` 中移除  
3. 若使用者仍存在，但其所依賴的角色消失，該使用者將僅剩自有的直接權限

---

### 🧪 範例一：刪除單個角色

假設你要刪除 `manager` 角色：
```sql
DROP ROLE 'manager'@'%';
```

🔍 刪除後：
- 所有使用該角色的使用者將失去 `manager` 帶來的所有權限
- 可用 `SHOW GRANTS FOR 'alice'@'localhost';` 驗證是否已失去角色權限

---

### 🧪 範例二：一次刪除多個角色

```sql
DROP ROLE 'hr', 'sales', 'temp_role';
```

這會同時清除三個角色的所有定義與授權，系統會自動更新角色與使用者的映射表。

---

### 🛡️ 刪除前的檢查建議：

1. **查詢角色是否存在：**
```sql
SELECT user, host FROM mysql.user WHERE account_locked='Y';
```
> 鎖定帳號（角色）通常就是角色帳號

2. **查詢哪些使用者使用了該角色：**
```sql
SELECT * FROM mysql.roles_mapping WHERE role = 'manager' AND host = '%';
```

3. **查詢角色擁有哪些權限：**
```sql
SHOW GRANTS FOR 'manager'@'%';
```

---

### ✅ 小總結

| 操作        | 語法範例 |
|-------------|----------|
| 刪除單個角色 | `DROP ROLE 'manager'@'%';` |
| 刪除多個角色 | `DROP ROLE 'sales', 'hr';` |
| 查使用者角色關聯 | `SELECT * FROM mysql.roles_mapping WHERE role = 'role';` |
| 刪除後檢查權限 | `SHOW GRANTS FOR 'user';` |

---

## 5.7 👤 给用户赋予角色
### 📘 為什麼需要將角色賦予使用者？

MySQL 中的角色只是**權限的集合本體**，不會自動與任何使用者產生關聯。  
你必須使用 `GRANT` 將角色明確地分配給使用者，否則使用者即使存在，也無法透過角色獲得任何權限。

---

### 🔸 語法結構

```sql
GRANT '角色1', '角色2' TO '使用者1', '使用者2';
```

- `角色` 可一次指定多個
- `使用者` 也可一次指定多個
- host 若省略，預設為 `%`

---

### 🧪 實務練習：完整三步操作

#### ✅ 步驟 1：給使用者賦予角色

```sql
GRANT 'school_read' TO 'kangshifu'@'localhost';
```

---

#### ✅ 步驟 2：確認角色是否已授予

```sql
SHOW GRANTS FOR 'kangshifu'@'localhost';
```

可能顯示如下結果：

```
GRANT USAGE ON *.* TO 'kangshifu'@'localhost'
GRANT 'school_read' TO 'kangshifu'@'localhost'
```

這表示 `kangshifu` 已經獲得角色 `school_read`，但還未啟用。

---

#### ✅ 步驟 3：登入使用者後查詢當前角色

```sql
SELECT CURRENT_ROLE();
```

如結果為：
```
+----------------+
| CURRENT_ROLE() |
+----------------+
| NONE           |
+----------------+
```

則代表使用者雖然擁有角色，但尚未啟用。

---

### ⚙️ 補充：如何激活角色

---

#### 🔹 方法一：手動啟用角色（登入後執行）

```sql
SET ROLE 'school_read';
```

再次查詢：
```sql
SELECT CURRENT_ROLE();
```

結果：
```
+----------------+
| CURRENT_ROLE() |
+----------------+
| school_read    |
+----------------+
```

---

#### 🔹 方法二：設為預設角色（登入時自動啟用）

如果你希望使用者登入時自動啟用角色，可以這樣設定：

```sql
SET DEFAULT ROLE 'school_read' TO 'kangshifu'@'localhost';
```

此後，`kangshifu` 每次登入都會自動擁有 `school_read` 的權限。

---

### 🛡️ 補充：一次分配多角色與多使用者

#### ✅ 多角色 → 多使用者

```sql
GRANT 'hr_viewer', 'finance_read' TO 'alice'@'localhost', 'bob'@'%';
```

這會讓 alice 與 bob 同時擁有 `hr_viewer` 與 `finance_read` 兩個角色的權限（前提是已存在的角色）。

---

### 📝 小結表格

| 操作類型         | 指令或結果 |
|------------------|------------|
| 賦予角色給使用者 | `GRANT 'role' TO 'user';` |
| 檢查是否成功     | `SHOW GRANTS FOR 'user';` |
| 查目前啟用角色   | `SELECT CURRENT_ROLE();` |
| 啟用角色（手動） | `SET ROLE 'role';` |
| 設為預設角色     | `SET DEFAULT ROLE 'role' TO 'user';` |

---

## 5.8 ✅ 激活角色
### 📘 為什麼角色要「激活」？

在 MySQL 中，即使一個使用者已經被授予某些角色，**這些角色預設是“未啟用”狀態**。  
只有在角色被激活之後，使用者才能真正擁有該角色所帶來的權限。

這樣設計的好處是：
- 支援動態切換角色權限
- 控制權限使用更加精細與安全

---

### 🧩 激活角色的兩種方式

---

#### 🔹 方式一：**使用 `SET DEFAULT ROLE` 設定預設角色**

這種方式是「為使用者設定登入後應該啟用哪些角色」。

##### ✅ 語法：
```sql
SET DEFAULT ROLE ALL TO '使用者'@'主機';
-- 或
SET DEFAULT ROLE '角色名' TO '使用者'@'主機';
```

##### 🧪 範例：

```sql
-- 為 kangshifu 使用者預設啟用所有被授予的角色
SET DEFAULT ROLE ALL TO 'kangshifu'@'localhost';

-- 指定只啟用特定角色
SET DEFAULT ROLE 'manager'@'%' TO 'kangshifu'@'localhost';
```

##### 🔍 批量設定範例：
```sql
SET DEFAULT ROLE ALL TO
  'dev1'@'localhost',
  'read_user1'@'localhost',
  'read_user2'@'localhost',
  'rw_user1'@'localhost';
```

##### ⚠️ 注意：
- 設定後 **需重新登入** 該帳號，才會生效！
- 此設定保存在系統資料表中，永久有效（除非變更）

---

#### 🔹 方式二：**全局開啟自動啟用所有角色**

此方法透過修改系統變數，讓所有使用者一登入就自動啟用所有擁有的角色。

##### ✅ 查看目前設定：
```sql
SHOW VARIABLES LIKE 'activate_all_roles_on_login';
```

##### ✅ 設定啟用：
```sql
SET GLOBAL activate_all_roles_on_login = ON;
```

> ⚠️ 此設定為「全域設定」，所有新登入的使用者都會自動啟用所有角色。

---

#### 📌 補充：查詢目前啟用的角色

```sql
SELECT CURRENT_ROLE();
```

---

### 🧪 實務操作範例：完整流程

```sql
-- 建立角色並授予查詢權限
CREATE ROLE 'school_read';
GRANT SELECT ON school.students TO 'school_read';

-- 建立使用者
CREATE USER 'kangshifu'@'localhost' IDENTIFIED BY '123456';

-- 賦予角色
GRANT 'school_read' TO 'kangshifu'@'localhost';

-- 設定預設角色
SET DEFAULT ROLE 'school_read' TO 'kangshifu'@'localhost';

-- 重新登入後使用者查詢已啟用角色
SELECT CURRENT_ROLE();

-- 執行查詢驗證權限是否生效
SELECT * FROM school.students;
```

---

### 🛠️ 小結比較

| 方法                     | 說明                                | 是否需重登入 | 影響範圍       |
|--------------------------|-------------------------------------|---------------|----------------|
| `SET DEFAULT ROLE`       | 為指定使用者設定預設角色             | ✅ 是         | 個別使用者     |
| `activate_all_roles_on_login = ON` | 登入時自動啟用所有角色            | ✅ 是         | 所有使用者（全域） |

---

## 5.9 🔄 撤销用户的角色
### 📘 說明

使用 `REVOKE` 可以從使用者帳號中移除已指派的角色，這會讓該使用者**立即失去透過該角色所擁有的權限**。

這對於以下場景非常實用：
- 員工離職或調職時收回其權限
- 錯誤分配角色時做緊急修正
- 符合最小權限原則的安全管理

---

### 🔸 語法結構

```sql
REVOKE '角色名稱' FROM '使用者名稱'@'主機';
```

- 支援一次撤銷多個角色，也可從多個使用者撤銷
- 角色名稱可省略主機名（如果與使用者設定一致）

---

### 🧪 基本練習：撤銷單一角色

#### ✅ 步驟 1：撤銷角色
```sql
REVOKE 'school_read' FROM 'kangshifu'@'localhost';
```

#### ✅ 步驟 2：查詢剩餘權限
```sql
SHOW GRANTS FOR 'kangshifu'@'localhost';
```

🔍 結果顯示中若不再有 `GRANT 'school_read'...` 就代表撤銷成功。

---

### 📎 說明補充：REVOKE 並不會刪除使用者，也不會刪除角色

- 被移除的角色本身仍然存在
- 使用者仍然可以被授予其他角色或權限
- 使用者若先前擁有其他獨立權限，不會受影響

---

### 🧪 進階範例：一次撤銷多角色、多使用者

```sql
-- 從 alice 與 bob 移除多個角色
REVOKE 'sales_read', 'finance_read' FROM 'alice'@'localhost', 'bob'@'%';
```

---

### 🛠️ 補充：查詢使用者擁有哪些角色

若要確認某個使用者擁有哪些角色，可以執行：

```sql
SELECT * 
FROM information_schema.enabled_roles 
WHERE user = 'kangshifu' AND host = 'localhost';
```

或者單純使用：

```sql
SHOW GRANTS FOR 'kangshifu'@'localhost';
```

---

### ❗ 常見錯誤解析

| 錯誤訊息                           | 原因與解法                                 |
|----------------------------------|--------------------------------------------|
| `ERROR 1141 (42000): There is no such grant defined...` | 表示該使用者沒有被賦予該角色，無需撤銷 |
| `SHOW GRANTS` 結果中還看得到角色 | 可能該角色是透過其他方式授予（再次檢查 host 名） |
| 撤銷後仍能操作資料表              | 該使用者可能擁有**額外直接授予的權限**，非來自角色 |

---

### ✅ 總結：撤銷角色流程

| 步驟         | 指令範例 |
|--------------|----------|
| 1. 撤銷角色  | `REVOKE 'role' FROM 'user'@'host';` |
| 2. 驗證是否成功 | `SHOW GRANTS FOR 'user'@'host';` |
| 3. 檢查是否仍有該權限 | `SELECT CURRENT_ROLE();` 並實際操作查詢或執行 `SHOW GRANTS` |

---

## 5.10 🔒 设置强制角色(mandatory role)
### 📘 什麼是強制角色？

- **強制角色**是一種**無法取消、無法撤銷**的角色。
- 一旦被設為強制角色，**所有新連線的使用者帳號都會自動繼承該角色的權限**。
- 使用者無須手動激活、也不能關閉這些角色，即使未顯式指派也會生效。

---

### ✅ 強制角色 vs 預設角色差異

| 類型           | 是否強制 | 是否可手動調整 | 系統重啟是否保留 | 使用場景                     |
|----------------|----------|----------------|------------------|------------------------------|
| 預設角色       | ❌ 否     | ✅ 可使用 `SET DEFAULT ROLE` 設定 | ✅ 是        | 為特定帳號開啟角色            |
| 強制角色       | ✅ 是     | ❌ 不可調整或撤銷      | ✅ 是（若用 `PERSIST` 設定） | 安全規範統一設定、稽核用途     |

---

### 🛠️ 強制角色的設定方式

---

#### 🔹 方式一：伺服器啟動時設定（推薦於部署階段）

```ini
# 在 my.cnf 或 my.ini 中設定
[mysqld]
mandatory_roles='auditor,readonly@localhost'
```

- 生效時機：MySQL 啟動時載入
- 適用於部署階段、強化安全規範、稽核角色預設啟用

---

#### 🔹 方式二：執行時設定

##### ✅ 瞬時有效（重啟即失效）

```sql
SET GLOBAL mandatory_roles = 'readonly,compliance@localhost';
```

##### ✅ 永久保存（重啟後仍有效）

```sql
SET PERSIST mandatory_roles = 'readonly,compliance@localhost';
```

- 此語法會寫入 `mysqld-auto.cnf` 配置檔
- 可透過 `SHOW VARIABLES LIKE 'mandatory_roles';` 查詢目前設定

---

### 🧪 範例：完整流程演練

---

#### 🎯 需求情境：
企業要求：所有連進 MySQL 的使用者都要有一個基本審核查詢角色 `audit_read`。

---

#### ✅ 步驟 1：建立角色並授權
```sql
CREATE ROLE 'audit_read';
GRANT SELECT ON log_db.audit_logs TO 'audit_read';
```

---

#### ✅ 步驟 2：設為強制角色（持久設定）
```sql
SET PERSIST mandatory_roles = 'audit_read';
```

---

#### ✅ 步驟 3：測試新建立的使用者是否自動擁有該角色

```sql
CREATE USER 'test_user'@'localhost' IDENTIFIED BY '123456';

-- 登入後直接查詢角色
SELECT CURRENT_ROLE();
-- 即使沒指派，也會顯示 audit_read 已啟用

-- 查詢是否可以查 log_db 資料表
SELECT * FROM log_db.audit_logs;
```

✔️ 沒有額外指派、也未設定預設角色，但 `test_user` 仍擁有權限，代表強制角色生效。

---

#### ❗ 注意事項

1. **強制角色無法透過 `REVOKE` 移除，也無法用 `SET ROLE NONE` 取消**
2. **無論帳號是否存在於 `roles_mapping`，只要連進 MySQL 就自動繼承強制角色**
3. 適合使用於：
   - 日誌存取控制（如 `audit_read`）
   - 基礎查詢監控
   - 稽核系統共通查詢權限

---

#### 📋 補充：檢查目前強制角色設定

```sql
SHOW VARIABLES LIKE 'mandatory_roles';
```

---

### ✅ 小結

| 操作目的       | 指令或方式 |
|----------------|------------|
| 設定強制角色（啟動時） | `my.cnf` 中 `mandatory_roles='role1,...'` |
| 設定強制角色（執行時） | `SET GLOBAL`（暫時）或 `SET PERSIST`（永久） |
| 查看角色設定值         | `SHOW VARIABLES LIKE 'mandatory_roles';` |
| 建立強制角色用戶      | 無需 `GRANT`，使用者自動繼承角色權限 |

---

# 6. 配置文件的使用
## 🔧 6.1 MySQL 配置文件格式
### 📁 常見配置文件名稱與位置
MySQL 的配置文件通常為 `my.cnf`（Linux/Unix 系統）或 `my.ini`（Windows 系統）。常見位置如下：

- `/etc/my.cnf`
- `/etc/mysql/my.cnf`
- `/usr/local/mysql/etc/my.cnf`
- `C:\ProgramData\MySQL\MySQL Server X.Y\my.ini`（Windows）

---

### 🧩 組（Group）與啟動選項格式

MySQL 配置文件由**多個組（Group）**組成，每個組用中括號 `[]` 標示組名，對應不同的執行階段或命令行工具：

| 組名         | 作用說明 |
|--------------|----------|
| `[server]`     | 通用伺服器設定，可被多個模組讀取（但使用較少） |
| `[mysqld]`     | MySQL Server 的主設定（最常用） |
| `[mysqld_safe]` | mysqld_safe（安全啟動器）相關設定 |
| `[client]`     | 所有用戶端工具通用設定（例如：mysql、mysqldump） |
| `[mysql]`      | mysql 命令列客戶端專用設定 |
| `[mysqladmin]` | mysqladmin 工具的專用設定 |

---

### ⚙️ 配置語法細節

- ❌ 不允許使用 `--` 前綴（與命令行不同）
- ✅ 支援註解，以 `#` 或 `;` 開頭直到行尾
- ✅ 每個選項獨立一行，格式為：
  - 不帶值的選項：`skip-name-resolve`
  - 帶值的選項：`max_connections = 200`
- ✅ `=` 可有空白（與命令列不同）

---

### 📘 配置文件範例

```ini
# my.cnf - MySQL 配置文件範例

[client]
user = root
password = mysecret
port = 3306
socket = /var/lib/mysql/mysql.sock

[mysql]
no-auto-rehash
prompt = '\u@\h [\d]> '

[mysqld]
user = mysql
basedir = /usr/local/mysql
datadir = /var/lib/mysql
port = 3306
socket = /var/lib/mysql/mysql.sock
character-set-server = utf8mb4
max_connections = 200
sql_mode = STRICT_ALL_TABLES
skip-name-resolve   # 不解析 DNS，可加快連線速度
log-error = /var/log/mysql/mysqld.log
pid-file = /var/run/mysqld/mysqld.pid

[mysqld_safe]
log-error = /var/log/mysql/mysqld_safe.log
pid-file = /var/run/mysqld/mysqld_safe.pid
```

---

### 🧪 實作練習建議

1. 找到你系統上的 `my.cnf` 或 `my.ini`
2. 嘗試新增一個 `[mysql]` 組，設定 `prompt` 為個性化樣式
3. 修改 `[mysqld]` 加入 `sql_mode = STRICT_TRANS_TABLES`
4. 重新啟動 MySQL 檢查是否生效：
   ```bash
   sudo systemctl restart mysql
   mysql -u root -p
   SHOW VARIABLES LIKE 'sql_mode';
   ```

---

## 🚀 6.2 啟動命令與選項組
### 📌 不同啟動命令對應可讀取的選項組

MySQL 的不同命令（或稱為**啟動程式/工具**）在讀取配置文件（如 `/etc/my.cnf`、`~/.my.cnf`）時，會根據自己的類型**只讀取對應的組（Group）設定**，以下是常見命令與其可讀取的選項組：

| 命令或工具        | 可讀取的選項組                            |
|------------------|-------------------------------------------|
| `mysqld`         | `[server]`、`[mysqld]`                     |
| `mysqld_safe`    | `[server]`、`[mysqld_safe]`、`[mysqld]`    |
| `mysql`          | `[client]`、`[mysql]`                      |
| `mysqladmin`     | `[client]`、`[mysqladmin]`                 |
| `mysqldump`      | `[client]`、`[mysqldump]`                  |
| `mysqlcheck`     | `[client]`、`[mysqlcheck]`                 |

---

### 🧠 特別注意的兩個選項組

- `[server]`：**作用於所有伺服器程序**（例如 `mysqld`、`mysqld_safe`），但內容較簡單，常用於通用設定。
- `[client]`：**作用於所有客戶端程序**，如 `mysql`、`mysqladmin`、`mysqldump` 等。

---

### 📘 範例說明與實驗

#### ✅ 正確配置（會生效）

假設你在 `/etc/my.cnf` 中添加如下內容：

```ini
[server]
skip-networking
default-storage-engine = MyISAM
```

然後直接啟動伺服器程序：

```bash
mysqld
```

> ✅ `mysqld` 支援讀取 `[server]` 組，因此上述選項會生效：
- `skip-networking`：禁用 TCP/IP 網路連線，只允許本地 socket。
- `default-storage-engine=MyISAM`：預設的儲存引擎變成 MyISAM。

---

#### ❌ 錯誤配置（不生效）

如果你將上述選項誤放到 `[client]` 組中：

```ini
[client]
skip-networking
default-storage-engine = MyISAM
```

然後再啟動：

```bash
mysqld
```

> ❌ **將不會生效**，因為 `mysqld` 不會讀取 `[client]` 組中的設定。

---

### 🧪 建議實作練習

你可以透過下列方式驗證不同組的生效情況：

1. 在 `/etc/my.cnf` 中加入：
   ```ini
   [server]
   skip-networking
   ```

2. 啟動 mysqld：
   ```bash
   mysqld --verbose
   ```

3. 查看是否 TCP 監聽已被禁用：
   ```bash
   netstat -tulnp | grep mysql
   ```

若 `skip-networking` 生效，則不會看到 TCP 的 3306 端口。

---

如果你需要我幫你設計一份完整的 `my.cnf` 文件範本或模擬一個開發與測試環境的設定範例，我也可以幫你整理。是否需要我補上這部分？

## 🧩 6.3 特定 MySQL 版本的專用選項組
### 📘 說明

MySQL 配置文件允許你**根據 MySQL 的版本指定特定的選項組**，以實現對不同版本做不同配置。

這種機制非常適合在一台機器上同時測試、運行多個不同版本的 MySQL，或在升級版本時逐步調整參數。

### 🧷 語法格式

```ini
[mysqld-版本號]
# 這些選項只在指定版本的 mysqld 啟動時生效
```

> 📌 這些版本號必須與 `mysqld --version` 輸出中顯示的主要版本一致，例如 `mysqld  Ver 5.7.43` 對應 `[mysqld-5.7]`。

---

### 🧪 實作範例

#### ✅ 配置文件 `/etc/my.cnf`：

```ini
[mysqld]
port = 3306
datadir = /var/lib/mysql
character-set-server = utf8mb4

[mysqld-5.7]
sql_mode = STRICT_ALL_TABLES

[mysqld-8.0]
sql_mode = STRICT_TRANS_TABLES,NO_ZERO_DATE
default_authentication_plugin = caching_sha2_password
```

#### 🧠 解釋：

| 選項組       | 說明                                                                 |
|--------------|----------------------------------------------------------------------|
| `[mysqld]`    | 所有版本都共用的通用設定                                               |
| `[mysqld-5.7]`| 只有 5.7.x 版本的 mysqld 執行檔會讀取這些設定                             |
| `[mysqld-8.0]`| 只有 8.0.x 版本會讀取，適用於新版新增的參數（如 `caching_sha2_password`） |

---

#### 🔍 驗證方式

1. 使用以下指令查看目前 mysqld 版本：
   ```bash
   mysqld --version
   ```

   假設輸出：
   ```
   mysqld  Ver 8.0.36 for Linux on x86_64 (MySQL Community Server - GPL)
   ```

2. 啟動 `mysqld` 後，檢查是否有套用 `sql_mode = STRICT_TRANS_TABLES,NO_ZERO_DATE` 和 `default_authentication_plugin = caching_sha2_password`。

3. 可用以下方式確認變數值：

   ```sql
   SHOW VARIABLES LIKE 'sql_mode';
   SHOW VARIABLES LIKE 'default_authentication_plugin';
   ```

---

### 🔐 補充小知識：組名優先順序

若同一參數在多個組都定義了，**優先順序如下（從低到高）**：

```
[server] < [mysqld] < [mysqld-5.7]（或對應版本）
```

也就是說，**版本專用組會覆蓋通用組的同名選項**。

---

需要我幫你產出一份根據你的 MySQL 版本自動切換的 my.cnf 模板嗎？或者是否想模擬不同版本之間的配置差異行為？我可以幫你設計練習題。

## 🧩 6.4 同一個配置文件中多個組的優先級
### 📘 說明

當一個 **MySQL 工具/命令** 可以讀取多個選項組時，**如果在這些組中出現了相同的設定項目**，則：

👉 **優先採用配置文件中「後出現」的選項組中的設定**。

這是因為 MySQL 在讀取配置文件時，是**按順序從上到下解析的**。若同一選項在多個組中都出現，後面的值會覆蓋前面的。

---

### 🧪 範例：同一選項出現在 `[server]` 與 `[mysqld]`

#### 配置檔案：`~/.my.cnf`

```ini
[server]
default-storage-engine = InnoDB

[mysqld]
default-storage-engine = MyISAM
```

#### 使用方式

```bash
mysqld
```

#### 🔍 解釋：

- `mysqld` 這個命令可以同時讀取 `[server]` 和 `[mysqld]` 組。
- 雖然兩組都設定了 `default-storage-engine`，但因為 `[mysqld]` 在 `[server]` 之後，因此：
  > ✅ 最終生效的是 `[mysqld]` 中的 `default-storage-engine = MyISAM`

---

### 📚 補充：常見的選項組優先順序說明

雖然不同組的名稱本身沒有固定優先級，但若一個命令能讀取多個組，則「後定義的組會覆蓋前面的設定」。例如：

#### 配置檔（節錄）

```ini
[server]
port = 3306

[mysqld]
port = 3307
```

執行：
```bash
mysqld
```

✅ 最終會採用 `port = 3307`，因為 `[mysqld]` 在 `[server]` 之後。

---

### ✅ 小結：選項解析原則

| 條件                                             | 結果                          |
|--------------------------------------------------|-------------------------------|
| 相同選項出現在多個 **可讀組**                    | 以**最後出現的組**為準       |
| 相同選項出現在不同 **配置文件**（多檔合併時）    | 以**最後被加載的檔案**為準   |
| 相同選項出現在配置文件和命令列                   | 以**命令列參數**為準         |

---

如果你有多版本配置管理需求，我也可以幫你整理一份範本讓你靈活切換。是否需要我補上這部分？

## 6.5 🧩 命令行與配置文件中啟動選項的區別 
### 📘 說明

MySQL 支援兩種方式設定啟動選項：

1. **命令行參數**  
   ➤ 適合臨時性、測試用途，直接在啟動命令後指定選項。

2. **配置文件參數**（如 `/etc/my.cnf`、`~/.my.cnf`）  
   ➤ 適合持久性設定，常駐於伺服器中使用。

---

### 🔍 差異一覽表

| 項目                           | 命令行選項                          | 配置文件選項                       |
|--------------------------------|-------------------------------------|------------------------------------|
| 格式                           | `--key=value`                      | `key = value`                      |
| 是否支援空格                   | ❌ `--key = value` 會錯誤            | ✅ `key = value` 可接受空白         |
| 可使用位置                     | 終端啟動時臨時指定                  | 常駐配置檔案中                     |
| 作用範圍                       | 只對當次啟動有效                   | 對所有啟動（除非被覆蓋）皆有效    |
| 優先順序                       | ✅ **優先於配置文件**               | ❌ 若被命令列覆蓋則無效            |
| 特殊選項（如指定配置檔）       | ✅ 可使用 `--defaults-file=xxx.cnf` | ❌ **不能**在配置文件內指定自己    |

---

#### 🚫 不可放入配置文件的特殊命令行選項

以下這些是 **專門為命令行設計** 的選項，不能或不應寫進配置文件：

- `--defaults-file=...`：指定 **唯一一個** 配置文件路徑
- `--defaults-extra-file=...`：指定 **額外** 要讀取的配置文件
- `--no-defaults`：完全忽略所有預設配置文件
- `--help`、`--version`：命令行查詢資訊用

這些選項 **本身就是用來控制配置文件的**，若你寫在配置文件中，將完全沒有效果。

---

### 🧪 範例對比

#### ✅ 配置文件 `/etc/my.cnf`

```ini
[server]
default-storage-engine = InnoDB
```

#### ✅ 啟動命令（覆蓋設定）

```bash
mysql.server start --default-storage-engine=MyISAM
```

#### 🔍 結果說明：

- 配置檔中設為 `InnoDB`
- 命令行指定為 `MyISAM`
- ✅ 最終生效：`MyISAM`（**命令行優先**）

---

### 📘 小技巧：同時使用配置文件與命令列選項的建議方式

#### ➤ 明確指定使用的配置文件

```bash
mysqld --defaults-file=/etc/my.cnf --default-storage-engine=MyISAM
```

- `--defaults-file=...`：先指定只讀取哪個配置檔
- `--default-storage-engine=...`：覆蓋裡面的設定

---

### ✅ 小結：優先順序總結

MySQL 解析啟動選項時的**最終優先順序如下（從低到高）**：

```
[server] < [mysqld] < [mysqld-version] < 命令列參數
```

即：**命令行始終擁有最高優先權**！

---

如果你有實務環境需求，我可以幫你設計一份實用的 `my.cnf` 配置文件，並提供搭配命令行的啟動範本。需要的話隨時告訴我！

# 7. 系統變量